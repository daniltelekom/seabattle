<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SeaStrike ‚Äî Telegram Mini App</title>

  <!-- Telegram Web App SDK (–Ω—É–∂–µ–Ω –¥–ª—è —Ä–∞–±–æ—Ç—ã –≤–Ω—É—Ç—Ä–∏ Telegram) -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:sans-serif;padding:16px;background:#e3f2fd}
    .screen{display:none}
    #screen-menu{display:block}
    .btn{display:block;width:100%;padding:14px;margin:8px 0;border:none;border-radius:10px;background:#1976d2;color:white;font-weight:700;cursor:pointer}
    .grid{display:grid;grid-template-columns:repeat(10,1fr);gap:2px;margin:16px 0}
    .cell{aspect-ratio:1;background:#bbdefb;border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:12px;color:#0b3d91}
    .ships-panel{display:flex;flex-wrap:wrap;gap:8px;margin:16px 0}
    .ship{background:#2196f3;width:36px;height:24px;border-radius:4px;display:flex;align-items:center;justify-content:center;color:white;font-weight:700;cursor:grab}
    h2,h3{margin:8px 0}
    #status{margin:8px 0;font-weight:700}
  </style>
</head>
<body>
  <div id="screen-menu" class="screen">
    <h2>SeaStrike</h2>
    <button class="btn" onclick="startMatch()">‚ñ∂Ô∏è –ù–∞—á–∞—Ç—å –º–∞—Ç—á</button>
  </div>

  <div id="screen-placement" class="screen">
    <h3>–†–∞—Å—Å—Ç–∞–≤—å—Ç–µ –∫–æ—Ä–∞–±–ª–∏ (–ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –Ω–∞ –ø–æ–ª–µ)</h3>
    <div class="ships-panel" id="shipsPanel"></div>
    <div class="grid" id="myField"></div>
    <button class="btn" id="readyBtn" onclick="submitPlacement()" disabled>‚úÖ –ì–æ—Ç–æ–≤–æ</button>
  </div>

  <div id="screen-waiting" class="screen">
    <h3>üïó –û–∂–∏–¥–∞–Ω–∏–µ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞‚Ä¶</h3>
  </div>

  <div id="screen-match" class="screen">
    <div id="status">üéØ –í–∞—à —Ö–æ–¥</div>
    <div class="grid" id="enemyField"></div>
    <div class="grid" id="myFieldBattle"></div>
  </div>

  <script>
    // ----------------- Telegram WebApp init (–±–µ–∑ —Ñ–µ–π–ª–æ–≤ –≤ –±—Ä–∞—É–∑–µ—Ä–µ) -----------------
    const WebApp = window.Telegram?.WebApp || null;
    // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –≤ Telegram, WebApp.initDataUnsafe.user –¥–∞—Å—Ç –æ–±—ä–µ–∫—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    // –ï—Å–ª–∏ –Ω–µ –≤ Telegram (–ø—Ä–æ–≤–µ—Ä–∫–∞/–ª–æ–∫–∞–ª—å–Ω–∞—è –æ—Ç–ª–∞–¥–∫–∞), —è —Å—Ç–∞–≤–ª—é –∑–∞–≥–ª—É—à–∫—É.
    const initUser = WebApp?.initDataUnsafe?.user || { id: 12345, username: 'local_test' };
    const userId = initUser.id;

    if (WebApp) {
      try { WebApp.expand?.(); } catch(e) { console.warn('WebApp.expand error', e); }
    } else {
      console.log('–ù–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω Telegram.WebApp ‚Äî —Ä–∞–±–æ—Ç–∞–µ–º –≤ —Ç–µ—Å—Ç–æ–≤–æ–º —Ä–µ–∂–∏–º–µ (user id=' + userId + ')');
    }

    // ----------------- –ü–æ–ø—ã—Ç–∫–∞ —Å–æ–∑–¥–∞—Ç—å –≤–æ—Ä–∫–µ—Ä mock-backend (–µ—Å–ª–∏ GitHub Pages —Ä–∞–∑—Ä–µ—à–∏—Ç) -----------------
    let worker = null;
    try {
      // worker —Ñ–∞–π–ª –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ —Ç–æ–π –∂–µ –ø–∞–ø–∫–µ –∏ –Ω–∞–∑—ã–≤–∞—Ç—å—Å—è mock-worker.js
      worker = new Worker('mock-worker.js');
    } catch (err) {
      console.warn('–í–æ—Ä–∫–µ—Ä –Ω–µ —Å–æ–∑–¥–∞–Ω, –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π mock (fallback).', err);
      worker = null;
    }

    // mockFetch: –µ—Å–ª–∏ –µ—Å—Ç—å –≤–æ—Ä–∫–µ—Ä ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –µ–≥–æ, –∏–Ω–∞—á–µ –ª–æ–∫–∞–ª—å–Ω—ã–π fallback
    function mockFetch(path, data = {}) {
      if (worker) {
        return new Promise(resolve => {
          const url = 'http://mock' + path;
          const onMessage = (e) => {
            if (e.data && e.data.url === url) {
              resolve(e.data.result);
              worker.removeEventListener('message', onMessage);
            } else if (e.data && e.data.error) {
              resolve(e.data);
              worker.removeEventListener('message', onMessage);
            }
          };
          worker.addEventListener('message', onMessage);
          worker.postMessage({ url: 'http://mock' + path, method: 'POST', body: data });
        });
      } else {
        // fallback: inline endpoints (—Ç–æ—Ç –∂–µ –∫–æ–Ω—Ç—Ä–∞–∫—Ç)
        const endpoints = {
          '/health': () => ({ status: 'ok', service: 'Mock Backend' }),
          '/player': (d={})=>({ telegram_id: d.telegram_id || userId, username: d.username || 'Player', rating:1000, skin_ship:'default', skin_board:'wood', frame:'none' }),
          '/match/random/join': ()=>({ status:'matched', match_id:'demo-123', opponent_id:999999, is_your_turn:true }),
          '/match/demo-123/place-ships': ()=>({ status:'ok' }),
          '/match/demo-123/wait-ready': ()=>({ status:'ready' }),
          '/match/demo-123/attack': (data={}) => {
            const r = Math.random();
            const hit = r < 0.3 ? 2 : r < 0.6 ? 1 : 0;
            const finished = hit === 2 && Math.random() < 0.1;
            return { hit, new_turn:999999, finished, winner_id: finished ? (Math.random()<0.5 ? (data.telegram_id||userId) : null) : null };
          }
        };
        return new Promise(resolve => setTimeout(()=> resolve(endpoints[path] ? endpoints[path](data) : { error:'not found' }), 80));
      }
    }

    // ----------------- UI + –ª–æ–≥–∏–∫–∞ (–º–∏–Ω–∏–º–∞–ª–∫–∞) -----------------
    function showScreen(id){
      document.querySelectorAll('.screen').forEach(s=>s.style.display='none');
      document.getElementById(id).style.display='block';
    }

    let myShips = [];

    function startMatch(){
      showScreen('screen-placement');
      initPlacement();
    }

    function initPlacement(){
      const panel = document.getElementById('shipsPanel'); panel.innerHTML = '';
      [4,3,3,2,2,2,1,1,1,1].forEach(size=>{
        const d = document.createElement('div');
        d.className = 'ship';
        d.draggable = true;
        d.innerText = size;
        d.dataset.size = size;
        d.ondragstart = e => e.dataTransfer.setData('size', size);
        panel.appendChild(d);
      });

      const field = document.getElementById('myField'); field.innerHTML = '';
      for(let i=0;i<100;i++){
        const cell = document.createElement('div');
        cell.className = 'cell';
        cell.dataset.idx = i;
        cell.ondrop = e => { e.preventDefault(); const size = e.dataTransfer.getData('size'); placeShip(i, parseInt(size)); };
        cell.ondragover = e => e.preventDefault();
        field.appendChild(cell);
      }
      myShips = [];
      document.getElementById('readyBtn').disabled = true;
    }

    function placeShip(start, size) {
      // –ø—Ä–æ—Å—Ç–∞—è –ª–æ–≥–∏–∫–∞: –ø–∏—à–µ–º –∫–æ—Ä–∞–±–ª—å –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ, –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–ª–ª–∏–∑–∏–π
      myShips.push({ start, size });
      const field = document.getElementById('myField');
      for (let k = 0; k < size; k++) {
        const idx = start + k;
        if (field.children[idx]) field.children[idx].style.background = '#90caf9';
      }
      const total = myShips.reduce((s, sh) => s + sh.size, 0);
      if (total >= 20) document.getElementById('readyBtn').disabled = false;
    }

    async function submitPlacement() {
      await mockFetch('/match/random/join', { telegram_id: userId });
      await mockFetch('/match/demo-123/place-ships', { telegram_id: userId, ships: myShips });
      showScreen('screen-waiting');
      setTimeout(async () => {
        await mockFetch('/match/demo-123/wait-ready', { telegram_id: userId });
        showScreen('screen-match');
        initBattle();
      }, 600);
    }

    function initBattle() {
      ['enemyField','myFieldBattle'].forEach(id=>{
        const f = document.getElementById(id); f.innerHTML = '';
        for(let i=0;i<100;i++){
          const c = document.createElement('div'); c.className = 'cell';
          if (id === 'enemyField') { c.onclick = ()=> attack(i); c.style.cursor = 'pointer'; }
          f.appendChild(c);
        }
      });
    }

    async function attack(idx) {
      const result = await mockFetch('/match/demo-123/attack', { telegram_id: userId, x: idx % 10, y: Math.floor(idx / 10) });
      const cell = document.querySelectorAll('#enemyField .cell')[idx];
      cell.style.background = result.hit === 0 ? '#eceff1' : result.hit === 1 ? '#ffccbc' : '#f44336';
      const status = document.getElementById('status');
      if (result.finished) status.innerText = result.winner_id ? 'üèÜ –ü–æ–±–µ–¥–∞!' : 'üíÄ –ü–æ—Ä–∞–∂–µ–Ω–∏–µ';
      else status.innerText = (result.new_turn === userId) ? 'üéØ –í–∞—à —Ö–æ–¥' : 'üéØ –•–æ–¥ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞';
    }

    // —Å—Ç–∞—Ä—Ç–æ–≤—ã–π —ç–∫—Ä–∞–Ω
    showScreen('screen-menu');
  </script>
</body>
</html>
