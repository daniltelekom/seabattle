<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>SeaStrike ‚Äî MiniApp</title>

  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --accent:#1976d2;
      --bg:#e9f4ff;
      --card:#fff;
      --cell:#e8f3ff;
      --miss:#eceff1;
      --hit:#f44336;
      --occupied:#2b9cff;
      --pending:#ffd54f;
      --sunk:#b71c1c;
      --ship-img-size:64px;
    }

    *{box-sizing:border-box;margin:0;padding:0}

    body{
      font-family:system-ui,Roboto,Arial;
      margin:10px;
      background:var(--bg);
      color:#072146;
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height:100vh;
    }

    .header{display:flex;justify-content:space-between;align-items:center;gap:8px}
    .panel{background:var(--card);padding:10px;border-radius:12px;box-shadow:0 6px 18px rgba(2,20,60,0.06)}
    .layout{display:grid;grid-template-columns:1fr 320px;gap:12px}
    @media (max-width:920px){ .layout{grid-template-columns:1fr} }

    .field-wrap{display:flex;flex-direction:column;align-items:center;gap:8px}
    .big-grid{width:100%;max-width:560px;display:grid;grid-template-columns:repeat(10,1fr);gap:4px}
    .small-grid{width:260px;display:grid;grid-template-columns:repeat(10,1fr);gap:3px}

    .cell{
      aspect-ratio:1;
      background:var(--cell);
      border-radius:8px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:12px;
      user-select:none;
      overflow:hidden;
      position:relative;
    }
    .cell.occupied{color:white}
    .cell.miss{background:var(--miss);color:#90a4ae}
    .cell.hit{background:var(--hit);color:white}
    .cell.pending{background:var(--pending)}
    .cell.sunk{background:var(--sunk);color:white}

    .cell img.part{
      width:var(--ship-img-size);
      height:var(--ship-img-size);
      object-fit:contain;
      pointer-events:none;
      user-select:none;
      display:block;
      margin:auto;
    }

    .cell.dot{
      position:relative;
    }
    .cell.dot::after{
      content:'';
      position:absolute;
      width:32%;
      height:32%;
      border-radius:50%;
      background:#90a4ae;
    }

    .rotated{transform-origin:center center;transform:rotate(90deg);}

    .ships-panel{display:flex;flex-wrap:wrap;gap:8px}

    .ship-btn{
      padding:8px 10px;
      border-radius:8px;
      background:#2196f3;
      color:#fff;
      border:none;
      min-width:42px;
    }
    .ship-btn.selected{outline:3px solid #ffca28}

    .shop-btn{
      background:linear-gradient(90deg,#ffb74d,#ff8a65);
      border:none;
      color:#fff;
      padding:8px 10px;
      border-radius:8px;
    }

    .footer{
      position:fixed;
      left:10px;
      right:10px;
      bottom:10px;
      display:flex;
      gap:8px;
      z-index:20;
    }
    .footer .panel{flex:1;display:flex;justify-content:space-between;align-items:center;padding:10px}

    .info{font-size:13px;color:#263238}
    .small{font-size:12px;color:#3b4752}

    #dbg{
      position:fixed;right:8px;top:8px;
      background:rgba(0,0,0,0.75);color:#fff;
      padding:6px 8px;border-radius:6px;
      display:none;max-width:46%;
      white-space:pre-wrap;z-index:60;font-size:12px
    }

    input, select{padding:8px;border-radius:8px;border:1px solid #ddd}
    .compact{font-size:12px}
    .label-muted{font-size:12px;color:#607d8b}
    .enemy-title{font-weight:700;margin-bottom:6px}

    .sunk-preview{
      box-shadow:0 0 0 3px rgba(255,215,0,0.9),0 8px 30px rgba(0,0,0,0.15);
      transform:scale(1.06);
      transition:transform .28s ease, box-shadow .28s ease;
      border-radius:6px;
    }
    @keyframes reveal-sunk{
      0%{opacity:0;transform:scale(0.9);}
      60%{opacity:1;transform:scale(1.04);}
      100%{opacity:1;transform:scale(1);}
    }
    .sunk-reveal{animation:reveal-sunk .34s cubic-bezier(.2,.9,.3,1);}

    /* –ë–ê–ù–ù–ï–† –ß–ï–ô –•–û–î */
    .turn-banner{
      margin-top:8px;
      margin-bottom:4px;
      font-size:14px;
      font-weight:600;
      padding:4px 12px;
      border-radius:999px;
      background:#e0f2ff;
      color:#072146;
    }
    .turn-banner.my-turn{
      background:#c8e6c9;
      color:#1b5e20;
    }
    .turn-banner.enemy-turn{
      background:#ffe0b2;
      color:#e65100;
    }
  </style>
</head>
<body>
  <div class="header">
    <div>
      <h2>SeaStrike ‚Äî MiniApp</h2>
      <div class="small">–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –º–æ—Ä—Å–∫–æ–π –±–æ–π ‚Äî –∫–ª–∏–∫–∞–π –ø–æ –ø–æ–ª—é –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞, —á—Ç–æ–±—ã —Å—Ç—Ä–µ–ª—è—Ç—å.</div>
    </div>
    <div class="small">PlayerID: <span id="playerIdLabel">‚Äî</span></div>
  </div>

  <div class="layout">
    <!-- –õ–µ–≤–æ: –ø–æ–ª—è -->
    <div class="panel">
      <div id="fieldArea" class="field-wrap" style="margin-top:4px">
        <div>
          <div class="enemy-title">–ü–æ–ª–µ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞ (–∫–ª–∏–∫ ‚Äî —Å—Ç—Ä–µ–ª—è—Ç—å)</div>
          <div id="enemyField" class="big-grid" aria-label="–ü–æ–ª–µ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞"></div>
        </div>

        <!-- –ë–∞–Ω–Ω–µ—Ä —á–µ–π —Ö–æ–¥ -->
        <div id="turnBanner" class="turn-banner">
          –ñ–¥—ë–º –Ω–∞—á–∞–ª–∞ –º–∞—Ç—á–∞...
        </div>

        <div style="margin-top:12px">
          <div class="label-muted">–í–∞—à–µ –ø–æ–ª–µ</div>
          <div id="myField" class="small-grid" aria-label="–í–∞—à–µ –ø–æ–ª–µ"></div>
        </div>
      </div>

      <!-- –ö–Ω–æ–ø–∫–∏ –∫–æ—Ä–∞–±–ª–µ–π -->
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px">
        <div class="ships-panel" id="shipsPanel"></div>
        <div style="display:flex;gap:8px">
          <button id="rotateBtn" class="ship-btn">–ü–æ–≤–µ—Ä–Ω—É—Ç—å (H)</button>
          <button id="autoBtn" class="ship-btn">–ê–≤—Ç–æ</button>
        </div>
      </div>

      <!-- –°—Ç–∞—Ç—É—Å + –æ—Ç–º–µ–Ω–∞/—É–¥–∞–ª–µ–Ω–∏–µ -->
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px">
        <div id="status" class="small">–†–∞—Å—Å—Ç–∞–≤—å—Ç–µ –∫–æ—Ä–∞–±–ª–∏ –∏ –Ω–∞–∂–º–∏—Ç–µ –ì–æ—Ç–æ–≤.</div>
        <div style="display:flex;gap:8px">
          <button id="undoBtn" class="ship-btn">‚Ü∂ –û—Ç–º–µ–Ω–∏—Ç—å</button>
          <button id="eraseModeBtn" class="ship-btn">–£–¥–∞–ª–µ–Ω–∏–µ: –≤—ã–∫–ª</button>
        </div>
      </div>
    </div>

    <!-- –ü—Ä–∞–≤–æ: –º–µ–Ω—é -->
    <div>
      <div class="panel" style="display:flex;flex-direction:column;gap:10px">
        <!-- –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é -->
        <button id="quickPlayBtn" class="ship-btn" style="width:100%;font-size:16px;padding:12px 10px;">
          ‚ñ∂ –ò–≥—Ä–∞—Ç—å (–ø–æ–∏—Å–∫ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞)
        </button>

        <div class="label-muted" style="margin-top:4px;">–ò–≥—Ä–∞ —Å –¥—Ä—É–≥–æ–º</div>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="createMatchBtn" class="ship-btn">–°–æ–∑–¥–∞—Ç—å</button>
          <input id="matchIdInput" placeholder="match id" style="flex:1"/>
          <button id="joinMatchBtn" class="ship-btn">–í–æ–π—Ç–∏</button>
        </div>

        <div style="display:flex;gap:8px">
          <button id="leaveBtn" class="ship-btn" style="flex:1">–í—ã–π—Ç–∏</button>
          <button id="shopBtn" class="shop-btn" style="flex:1">–ú–∞–≥–∞–∑–∏–Ω</button>
        </div>

        <div style="display:flex;flex-direction:column;gap:6px" class="compact">
          <div class="info">Mode: <span id="modeLabel">railway</span></div>
          <div class="info">Match: <span id="matchLabel">‚Äî</span></div>
          <div class="info">Turn: <span id="turnLabel">‚Äî</span></div>
          <div class="info">Rating: <span id="ratingLabel">1000</span></div>
        </div>
      </div>
    </div>
  </div>

  <div id="dbg">DBG</div>

  <div class="footer">
    <div class="panel">
      <div class="info">–ü–æ–¥–¥–µ—Ä–∂–∫–∞: Railway (online socket)</div>
      <div style="display:flex;gap:8px">
        <button id="readyBtn" class="ship-btn">‚úÖ –ì–æ—Ç–æ–≤</button>
        <button id="resignBtn" class="ship-btn">–°–¥–∞—Ç—å—Å—è</button>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ –º–∞–≥–∞–∑–∏–Ω–∞ -->
  <div id="shopModal" style="display:none;position:fixed;left:0;top:0;right:0;bottom:0;align-items:center;justify-content:center;background:rgba(0,0,0,0.5);z-index:1000;">
    <div style="width:92%;max-width:420px;background:white;border-radius:14px;padding:14px;position:relative;text-align:center;box-shadow:0 10px 30px rgba(2,20,60,0.2);">
      <button id="shopClose" style="position:absolute;right:10px;top:10px;background:transparent;border:none;font-size:18px;cursor:pointer;">‚úï</button>
      <div style="font-size:18px;font-weight:700;margin-bottom:8px;">üéÅ –ú–∞–≥–∞–∑–∏–Ω —Å–∫–∏–Ω–æ–≤</div>
      <div id="shopModalContent" style="display:flex;flex-direction:column;gap:8px;max-height:60vh;overflow:auto;padding:6px;"></div>
      <div style="margin-top:10px;">
        <button id="shopModalBuyAll" class="ship-btn" style="background:linear-gradient(90deg,#4caf50,#388e3c);">–ö—É–ø–∏—Ç—å/–û—Ç–∫—Ä—ã—Ç—å –≤ –±–æ—Ç–µ</button>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ –∫–æ–Ω—Ü–∞ –º–∞—Ç—á–∞ -->
  <div id="endModal"
       style="display:none;position:fixed;left:0;top:0;right:0;bottom:0;
              align-items:center;justify-content:center;
              background:rgba(0,0,0,0.45);z-index:2000;">
    <div style="background:#fff;border-radius:12px;padding:16px 14px;
                max-width:320px;width:90%;box-shadow:0 10px 30px rgba(0,0,0,0.3);
                text-align:center;">
      <div id="endModalTitle"
           style="font-weight:700;font-size:18px;margin-bottom:6px;">
        –ú–∞—Ç—á –∑–∞–≤–µ—Ä—à—ë–Ω
      </div>
      <div id="endModalText"
           class="small"
           style="margin-bottom:12px;">
        –ü–æ–±–µ–¥–∏—Ç–µ–ª—å: ‚Äî
      </div>
      <div style="display:flex;gap:8px;justify-content:center;">
        <button id="endRematchBtn" class="ship-btn" style="flex:1;">–†–µ–≤–∞–Ω—à</button>
        <button id="endExitBtn" class="ship-btn"
                style="flex:1;background:#e53935;">–í—ã–π—Ç–∏</button>
      </div>
    </div>
  </div>

<script>
/* ====== –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ====== */
const SOCKET_URL = "https://seabattle-server-production.up.railway.app";
const SHOP_URL   = "https://t.me/YourBotOrShop";

/* ====== –°–∫–∏–Ω—ã (–ø—É—Ç–∏ –∫ –∫–∞—Ä—Ç–∏–Ω–∫–∞–º) ====== */
const SKINS = [
  { id:'blue', name:'Blue Steel', price:50, parts:{
    head:'assets/skins/blue_head.png',
    body:'assets/skins/blue_body.png',
    tail:'assets/skins/blue_tail.png',
    single:'assets/skins/blue_single.png'
  }},
  { id:'red', name:'Crimson', price:75, parts:{
    head:'assets/skins/red_head.png',
    body:'assets/skins/red_body.png',
    tail:'assets/skins/red_tail.png',
    single:'assets/skins/red_single.png'
  }},
  { id:'gold', name:'Gold', price:150, parts:{
    head:'assets/skins/gold_head.png',
    body:'assets/skins/gold_body.png',
    tail:'assets/skins/gold_tail.png',
    single:'assets/skins/gold_single.png'
  }}
];

/* ====== –ò–≥—Ä–æ–∫ ====== */
const WebApp   = window.Telegram?.WebApp || null;
const initUser = WebApp?.initDataUnsafe?.user || { id: Math.floor(Math.random()*1e6), username:'local_test' };
const PLAYER_ID   = String(initUser.id);
const PLAYER_NAME = initUser.username || ('p' + PLAYER_ID);
document.getElementById('playerIdLabel').innerText = PLAYER_ID;

/* ====== UI —ç–ª–µ–º–µ–Ω—Ç—ã ====== */
const enemyField   = document.getElementById('enemyField');
const myField      = document.getElementById('myField');
const shipsPanel   = document.getElementById('shipsPanel');
const rotateBtn    = document.getElementById('rotateBtn');
const autoBtn      = document.getElementById('autoBtn');
const undoBtn      = document.getElementById('undoBtn');
const eraseModeBtn = document.getElementById('eraseModeBtn');
const readyBtn     = document.getElementById('readyBtn');
const resignBtn    = document.getElementById('resignBtn');
const statusEl     = document.getElementById('status');

const quickPlayBtn   = document.getElementById('quickPlayBtn');
const createMatchBtn = document.getElementById('createMatchBtn');
const joinMatchBtn   = document.getElementById('joinMatchBtn');
const leaveBtn       = document.getElementById('leaveBtn');
const matchIdInput   = document.getElementById('matchIdInput');
const matchLabel     = document.getElementById('matchLabel');
const turnLabel      = document.getElementById('turnLabel');
const modeLabel      = document.getElementById('modeLabel');
const shopBtn        = document.getElementById('shopBtn');
const dbg            = document.getElementById('dbg');

/* –ú–∞–≥–∞–∑–∏–Ω –º–æ–¥–∞–ª–∫–∞ */
const shopModal        = document.getElementById('shopModal');
const shopModalContent = document.getElementById('shopModalContent');
const shopClose        = document.getElementById('shopClose');
const shopModalBuyAll  = document.getElementById('shopModalBuyAll');

/* –ú–æ–¥–∞–ª–∫–∞ –∫–æ–Ω—Ü–∞ –º–∞—Ç—á–∞ */
const turnBanner    = document.getElementById('turnBanner');
const endModal      = document.getElementById('endModal');
const endModalTitle = document.getElementById('endModalTitle');
const endModalText  = document.getElementById('endModalText');
const endRematchBtn = document.getElementById('endRematchBtn');
const endExitBtn    = document.getElementById('endExitBtn');

/* ====== –°–æ—Å—Ç–æ—è–Ω–∏–µ ====== */
let socket         = null;
let currentMatchId = null;
let currentTurn    = null;
let matchFinished  = false;

/* —Ä–∞—Å—Å—Ç–∞–Ω–æ–≤–∫–∞ */
const SHIP_SIZES = [4,3,3,2,2,2,1,1,1,1];
function group(arr){ const out={}; arr.forEach(s=>out[s]=(out[s]||0)+1); return out; }
let shipsPool    = group(SHIP_SIZES);
let placed       = [];
let nextShipId   = 1;
let selectedSize = null;
let orientation  = 'H';
let eraseMode    = false;

/* —Å–∫–∏–Ω—ã */
let ownedSkins   = JSON.parse(localStorage.getItem('owned_skins') || '["blue"]');
let equippedSkin = localStorage.getItem('equipped_skin') || 'blue';

/* ====== helpers ====== */
function logDbg(msg){
  if(!dbg) return;
  dbg.style.display='block';
  try{ dbg.innerText = typeof msg === 'string' ? msg : JSON.stringify(msg,null,2); }
  catch(e){ dbg.innerText = String(msg); }
}
function coords(idx){ return { x:idx%10, y:Math.floor(idx/10) }; }
function cellIndex(x,y){ return y*10 + x; }
function cellsFor(start,size,orient){
  const p = coords(start); const cells=[];
  if(orient==='H'){
    for(let k=0;k<size;k++){
      const nx=p.x+k; if(nx>9) return null;
      cells.push(cellIndex(nx,p.y));
    }
  }else{
    for(let k=0;k<size;k++){
      const ny=p.y+k; if(ny>9) return null;
      cells.push(cellIndex(p.x,ny));
    }
  }
  return cells;
}
function adjacentCellsOf(c){
  const {x,y}=coords(c); const out=[];
  for(let dy=-1;dy<=1;dy++) for(let dx=-1;dx<=1;dx++){
    const nx=x+dx,ny=y+dy;
    if(nx>=0&&nx<10&&ny>=0&&ny<10) out.push(cellIndex(nx,ny));
  }
  return out;
}
function overlapsOrAdjacent(cells){
  const occ=new Set(placed.flatMap(s=>s.cells));
  for(const c of cells){
    if(occ.has(c)) return {overlap:true};
    for(const n of adjacentCellsOf(c)) if(occ.has(n)) return {adjacent:true,at:n};
  }
  return null;
}
function getSkinById(id){ return SKINS.find(s=>s.id===id) || SKINS[0]; }

/* –ë–∞–Ω–Ω–µ—Ä —á–µ–π —Ö–æ–¥ */
function updateTurnBanner(){
  if(!turnBanner) return;

  turnBanner.classList.remove('my-turn','enemy-turn');

  if(!currentMatchId){
    turnBanner.textContent = '–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –º–∞—Ç—á–∞';
    return;
  }
  if(matchFinished){
    turnBanner.textContent = '–ú–∞—Ç—á –∑–∞–≤–µ—Ä—à—ë–Ω';
    return;
  }
  if(String(currentTurn) === String(PLAYER_ID)){
    turnBanner.textContent = '–¢–≤–æ–π —Ö–æ–¥ ‚Äî —Å—Ç—Ä–µ–ª—è–π –ø–æ –ø–æ–ª—é –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞';
    turnBanner.classList.add('my-turn');
  }else{
    turnBanner.textContent = '–•–æ–¥ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞ ‚Äî –∂–¥–∏';
    turnBanner.classList.add('enemy-turn');
  }
}

/* –ú–æ–¥–∞–ª–∫–∞ –∫–æ–Ω—Ü–∞ */
function showEndModal(winnerId){
  if(winnerId && String(winnerId) === String(PLAYER_ID)){
    endModalText.textContent = '–¢—ã –≤—ã–∏–≥—Ä–∞–ª! üéâ';
  }else if(winnerId){
    endModalText.textContent = '–ü–æ–±–µ–¥–∏–ª —Å–æ–ø–µ—Ä–Ω–∏–∫.';
  }else{
    endModalText.textContent = '–ú–∞—Ç—á –∑–∞–≤–µ—Ä—à—ë–Ω.';
  }
  endModal.style.display = 'flex';
}
function hideEndModal(){
  endModal.style.display = 'none';
}

/* –ö–Ω–æ–ø–∫–∞ "–†–µ–≤–∞–Ω—à" –≤ –º–æ–¥–∞–ª–∫–µ */
endRematchBtn.addEventListener('click',()=>{
  if(!socket) initSocket();
  if(!currentMatchId){
    hideEndModal();
    return;
  }
  socket.emit('request_rematch',{matchId:currentMatchId,playerId:PLAYER_ID});
  updateStatus('–ó–∞–ø—Ä–æ—à–µ–Ω —Ä–µ–≤–∞–Ω—à, –∂–¥—ë–º —Å–æ–ø–µ—Ä–Ω–∏–∫–∞');
  hideEndModal();
});

/* –ö–Ω–æ–ø–∫–∞ "–í—ã–π—Ç–∏" –≤ –º–æ–¥–∞–ª–∫–µ */
endExitBtn.addEventListener('click',()=>{
  if(!socket) initSocket();
  if(currentMatchId){
    socket.emit('leave',{playerId:PLAYER_ID,matchId:currentMatchId});
  }
  currentMatchId = null;
  matchLabel.innerText = '‚Äî';
  matchFinished = false;
  hideEndModal();
  updateStatus('–í—ã –≤—ã—à–ª–∏ –≤ –º–µ–Ω—é');
  updateTurnBanner();
});


// —Å—Ç–∞–≤–∏–º —Ç–æ—á–∫–∏ –≤–æ–∫—Ä—É–≥ —É—Ç–æ–ø–ª–µ–Ω–Ω–æ–≥–æ –∫–æ—Ä–∞–±–ª—è
function markDotsAroundShip(gridEl, orderedCells){
  if(!orderedCells || !orderedCells.length) return;

  const shipIdxSet = new Set(
    orderedCells.map(c =>
      (typeof c === 'number') ? c : cellIndex(c.x, c.y)
    )
  );

  const used = new Set();

  shipIdxSet.forEach(idx=>{
    const {x,y}=coords(idx);
    for(let dy=-1;dy<=1;dy++){
      for(let dx=-1;dx<=1;dx++){
        const nx=x+dx, ny=y+dy;
        if(nx<0||nx>9||ny<0||ny>9) continue;

        const nIdx=cellIndex(nx,ny);
        if(shipIdxSet.has(nIdx)) continue;
        if(used.has(nIdx)) continue;
        used.add(nIdx);

        const cell = gridEl.children[nIdx];
        if(!cell) continue;
        if(
          cell.classList.contains('hit') ||
          cell.classList.contains('sunk')||
          cell.classList.contains('miss')
        ) continue;

        cell.classList.add('dot');
      }
    }
  });
}

/* ====== –ø–æ–ª—è ====== */
function buildFields(){
  enemyField.innerHTML='';
  for(let i=0;i<100;i++){
    const c=document.createElement('div');
    c.className='cell';
    c.dataset.idx=i;
    c.addEventListener('click', onEnemyClick);
    c.addEventListener('touchend', e=>{e.preventDefault(); onEnemyClick.call(c,e);});
    enemyField.appendChild(c);
  }
  myField.innerHTML='';
  for(let i=0;i<100;i++){
    const c=document.createElement('div');
    c.className='cell';
    c.dataset.idx=i;
    c.addEventListener('click', onMyCellClick);
    c.addEventListener('touchend', e=>{e.preventDefault(); onMyCellClick.call(c,e);});
    myField.appendChild(c);
  }
}

/* ====== —Ä–∞—Å—Å—Ç–∞–Ω–æ–≤–∫–∞ + –æ—Ç—Ä–∏—Å–æ–≤–∫–∞ ====== */
function renderShipsPanel(){
  shipsPanel.innerHTML='';
  const unique=Array.from(new Set(SHIP_SIZES)).sort((a,b)=>b-a);
  unique.forEach(size=>{
    const left = shipsPool[size] || 0;
    const btn  = document.createElement('button');
    btn.className='ship-btn' + (selectedSize===size ? ' selected':'');
    btn.type='button';
    btn.innerText = `${size} √ó ${left}`;
    const handler = e=>{
      e.preventDefault();
      if(left<=0){ updateStatus('–ù–µ—Ç —Ç–∞–∫–∏—Ö –∫–æ—Ä–∞–±–ª–µ–π'); return; }
      selectedSize = (selectedSize===size)?null:size;
      renderShipsPanel();
      updateStatus();
    };
    btn.addEventListener('click',handler);
    btn.addEventListener('touchend',e=>{e.preventDefault();handler(e);});
    shipsPanel.appendChild(btn);
  });
}

function renderAll(){
  document.querySelectorAll('#myField .cell').forEach(c=>{
    c.classList.remove('occupied','hit','miss','pending','sunk','dot');
    c.style.transform=''; c.innerHTML='';
  });
  const skin = getSkinById(equippedSkin);
  placed.forEach(ship=>{
    const parts=ship.cells;
    const size =ship.size;
    parts.forEach((cellIdx,i)=>{
      const el=myField.children[cellIdx];
      if(!el) return;
      let partName='body';
      if(size===1) partName='single';
      else if(i===0) partName='head';
      else if(i===parts.length-1) partName='tail';
      const url=skin.parts && skin.parts[partName];
      if(url){
        const img=document.createElement('img');
        img.className='part' + (ship.orientation==='V'?' rotated':'');
        img.draggable=false;
        img.src=url;
        el.appendChild(img);
      }else{
        el.style.background='var(--occupied)';
      }
      el.classList.add('occupied');
    });
  });
  renderShipsPanel();
  readyBtn.disabled = !allPlaced();
  updateStatus();
}
function allPlaced(){ return Object.values(shipsPool).every(v=>v===0); }

function placeShipAt(startIdx,size,orient){
  const cells=cellsFor(startIdx,size,orient);
  if(!cells) return {ok:false,reason:'out'};
  const bad=overlapsOrAdjacent(cells);
  if(bad){
    if(bad.overlap)  return {ok:false,reason:'overlap'};
    if(bad.adjacent) return {ok:false,reason:'adjacent'};
  }
  const ship={id:nextShipId++,size,start:startIdx,orientation:orient,cells};
  placed.push(ship);
  shipsPool[size]=(shipsPool[size]||0)-1;
  renderAll();
  return {ok:true,ship};
}
function findShipByCell(idx){ return placed.find(s=>s.cells.includes(idx)); }
function removeShipById(id){
  const i=placed.findIndex(s=>s.id===id);
  if(i===-1) return false;
  const s=placed[i];
  shipsPool[s.size]=(shipsPool[s.size]||0)+1;
  placed.splice(i,1);
  renderAll();
  return true;
}

function updateStatus(msg){
  if(msg){ statusEl.innerText=msg; logDbg(msg); return; }
  if(matchFinished){ statusEl.innerText='–ú–∞—Ç—á –∑–∞–≤–µ—Ä—à—ë–Ω'; return; }
  if(allPlaced()) statusEl.innerText='–í—Å–µ –∫–æ—Ä–∞–±–ª–∏ —Ä–∞—Å—Å—Ç–∞–≤–ª–µ–Ω—ã ‚Äî –Ω–∞–∂–º–∏ –ì–æ—Ç–æ–≤';
  else if(selectedSize) statusEl.innerText=`–í—ã–±—Ä–∞–Ω–æ ${selectedSize} (–æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è ${orientation})`;
  else statusEl.innerText='–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ—Ä–∞–±–ª—å';
}

/* –∫–ª–∏–∫ –ø–æ —Å–≤–æ–µ–º—É –ø–æ–ª—é */
function onMyCellClick(e){
  const el=e.currentTarget || this;
  const idx=parseInt(el.dataset.idx);
  if(eraseMode){
    const ship=findShipByCell(idx);
    if(ship){ removeShipById(ship.id); updateStatus('–ö–æ—Ä–∞–±–ª—å —É–¥–∞–ª—ë–Ω'); }
    else updateStatus('–ù–µ—Ç –∫–æ—Ä–∞–±–ª—è');
    return;
  }
  if(!selectedSize){ updateStatus('–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ—Ä–∞–±–ª—å'); return; }
  const res=placeShipAt(idx,selectedSize,orientation);
  if(!res.ok){
    if(res.reason==='out')      updateStatus('–í—ã—Ö–æ–¥ –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã');
    else if(res.reason==='overlap')  updateStatus('–ü–µ—Ä–µ–∫—Ä—ã—Ç–∏–µ');
    else if(res.reason==='adjacent') updateStatus('–†—è–¥–æ–º –¥—Ä—É–≥–æ–π –∫–æ—Ä–∞–±–ª—å');
    else updateStatus('–ù–µ–ª—å–∑—è –ø–æ—Å—Ç–∞–≤–∏—Ç—å');
  }else{
    updateStatus('–ö–æ—Ä–∞–±–ª—å –ø–æ—Å—Ç–∞–≤–ª–µ–Ω');
    if((shipsPool[selectedSize]||0)<=0) selectedSize=null;
  }
}

/* –∫–Ω–æ–ø–∫–∏ —Ä–∞—Å—Å—Ç–∞–Ω–æ–≤–∫–∏ */
rotateBtn.addEventListener('click',()=>{
  orientation=(orientation==='H')?'V':'H';
  rotateBtn.innerText=`–ü–æ–≤–µ—Ä–Ω—É—Ç—å (${orientation})`;
  updateStatus();
});
autoBtn.addEventListener('click',()=>{ randomPlaceAll(); updateStatus('–ê–≤—Ç–æ-—Ä–∞—Å—Å—Ç–∞–Ω–æ–≤–∫–∞'); });
undoBtn.addEventListener('click',()=>{
  if(placed.length===0){ updateStatus('–ù–µ—á–µ–≥–æ –æ—Ç–º–µ–Ω—è—Ç—å'); return; }
  const last=placed.pop();
  shipsPool[last.size]=(shipsPool[last.size]||0)+1;
  renderAll();
  updateStatus('–û—Ç–º–µ–Ω—ë–Ω –ø–æ—Å–ª–µ–¥–Ω–∏–π');
});
eraseModeBtn.addEventListener('click',()=>{
  eraseMode=!eraseMode;
  eraseModeBtn.innerText=`–£–¥–∞–ª–µ–Ω–∏–µ: ${eraseMode?'–≤–∫–ª':'–≤—ã–∫–ª'}`;
});

function clearAll(){
  placed=[]; shipsPool=group(SHIP_SIZES); nextShipId=1;
  selectedSize=null; orientation='H'; eraseMode=false;
  eraseModeBtn.innerText='–£–¥–∞–ª–µ–Ω–∏–µ: –≤—ã–∫–ª';
  renderAll();
}
function randomPlaceAll(){
  clearAll();
  const sizes=[...SHIP_SIZES].sort(()=>Math.random()-0.5);
  for(const s of sizes){
    let tries=0,ok=false;
    while(tries<500 && !ok){
      const start=Math.floor(Math.random()*100);
      const orient=Math.random()<0.5?'H':'V';
      const cells=cellsFor(start,s,orient);
      if(cells && !overlapsOrAdjacent(cells)){
        placed.push({id:nextShipId++,size:s,start,orientation:orient,cells});
        shipsPool[s]=(shipsPool[s]||0)-1;
        ok=true;
      }
      tries++;
    }
    if(!ok) return randomPlaceAll();
  }
  renderAll();
}

/* ====== —Å—Ç—Ä–µ–ª—å–±–∞ –ø–æ –≤—Ä–∞–≥—É ====== */
function onEnemyClick(e){
  const el=e.currentTarget || this;
  const idx=parseInt(el.dataset.idx);

  if(matchFinished){ updateStatus('–ú–∞—Ç—á —É–∂–µ –∑–∞–≤–µ—Ä—à—ë–Ω'); return; }
  if(!currentMatchId){ updateStatus('–ù–µ—Ç –º–∞—Ç—á–∞ ‚Äî –Ω–∞–∂–º–∏ –ò–≥—Ä–∞—Ç—å –∏–ª–∏ –°–æ–∑–¥–∞—Ç—å'); return; }
  if(!currentTurn || String(currentTurn)!==String(PLAYER_ID)){ updateStatus('–°–µ–π—á–∞—Å –Ω–µ –≤–∞—à —Ö–æ–¥'); return; }
  if(el.classList.contains('miss')||el.classList.contains('hit')||el.classList.contains('sunk')||el.classList.contains('pending')){
    updateStatus('–í—ã —É–∂–µ —Å—Ç—Ä–µ–ª—è–ª–∏ —Å—é–¥–∞');
    return;
  }

  const {x,y}=coords(idx);
  if(!socket) initSocket();
  socket.emit('shoot',{matchId:currentMatchId,playerId:PLAYER_ID,x,y},(_,resp)=>{
    if(!resp || !resp.ok){
      if(resp && resp.error==='already_shot')  updateStatus('–í—ã —É–∂–µ —Å—Ç—Ä–µ–ª—è–ª–∏ —Å—é–¥–∞');
      else if(resp && resp.error==='not_your_turn') updateStatus('–°–µ–π—á–∞—Å –Ω–µ –≤–∞—à —Ö–æ–¥');
      else updateStatus('–û—à–∏–±–∫–∞ –≤—ã—Å—Ç—Ä–µ–ª–∞');
      el.classList.remove('pending');
      return;
    }
  });
  el.classList.add('pending');
  updateStatus(`–í—ã—Å—Ç—Ä–µ–ª: ${x},${y} ‚Äî –∂–¥—ë–º –æ—Ç–≤–µ—Ç–∞`);
}

/* ====== Socket.IO ====== */
function initSocket(){
  if(socket) return;
  if(!SOCKET_URL || !SOCKET_URL.startsWith('http')){
    updateStatus('–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π SOCKET_URL');
    return;
  }
  socket = io(SOCKET_URL,{transports:['websocket']});

  socket.on('connect',()=>{
    logDbg('socket connected: '+socket.id);
    socket.emit('identify',{playerId:PLAYER_ID,username:PLAYER_NAME});
  });
  socket.on('connect_error',err=>{ logDbg('connect_error: '+(err && err.message?err.message:err)); });
  socket.on('disconnect',reason=>{ logDbg('disconnect: '+reason); });

  socket.on('identified',()=>{ /* ok */ });

  socket.on('match_created',d=>{
    currentMatchId=d.matchId;
    matchLabel.innerText=currentMatchId;
    modeLabel.innerText='railway';
    updateStatus('–ú–∞—Ç—á —Å–æ–∑–¥–∞–Ω: '+currentMatchId);
    updateTurnBanner();
  });

  socket.on('match_joined',d=>{
    currentMatchId=d.matchId;
    matchLabel.innerText=currentMatchId;
    modeLabel.innerText='railway';
    updateStatus('–í –º–∞—Ç—á–µ: '+currentMatchId);
    updateTurnBanner();
  });

  socket.on('match_found',d=>{
    currentMatchId=d.matchId;
    matchLabel.innerText=currentMatchId;
    modeLabel.innerText='railway';
    currentTurn=d.turn;
    turnLabel.innerText=String(currentTurn||'‚Äî');
    updateStatus('–ù–∞–π–¥–µ–Ω –º–∞—Ç—á: '+currentMatchId);
    updateTurnBanner();
  });

  socket.on('placement_update',()=>updateStatus('–ü—Ä–æ—Ç–∏–≤–Ω–∏–∫ –æ—Ç–ø—Ä–∞–≤–∏–ª —Ä–∞—Å—Å—Ç–∞–Ω–æ–≤–∫—É'));

  socket.on('match_started', d => {
    currentMatchId = d.matchId;
    currentTurn   = d.turn;
    matchLabel.innerText = currentMatchId;
    turnLabel.innerText  = String(currentTurn || '‚Äî');

    // –ü–æ–ª–µ –≤—Ä–∞–≥–∞ ‚Äî –æ—á–∏—Å—Ç–∏—Ç—å
    enemyField.querySelectorAll('.cell').forEach(c => {
      c.className = 'cell';
      c.innerHTML = '';
    });

    // –ù–∞—à–µ –ø–æ–ª–µ ‚Äî —É–±—Ä–∞—Ç—å —Ç–æ–ª—å–∫–æ –º–µ—Ç–∫–∏ –≤—ã—Å—Ç—Ä–µ–ª–æ–≤
    myField.querySelectorAll('.cell').forEach(c => {
      c.classList.remove('miss','hit','pending','sunk','sunk-preview','sunk-reveal','dot');
    });

    matchFinished = false;
    hideEndModal();

    updateStatus(
      String(currentTurn) === String(PLAYER_ID)
        ? '–ú–∞—Ç—á –Ω–∞—á–∞–ª—Å—è ‚Äî —Ç–≤–æ–π —Ö–æ–¥, —Å—Ç—Ä–µ–ª—è–π –ø–æ –ø–æ–ª—é –≤—Ä–∞–≥–∞'
        : '–ú–∞—Ç—á –Ω–∞—á–∞–ª—Å—è ‚Äî —Ö–æ–¥ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞, –∂–¥–∏'
    );
    updateTurnBanner();
  });

  socket.on('shot_result', d => {
    if (!d) return;
    const idx = cellIndex(d.x, d.y);

    if (String(d.shooter) === String(PLAYER_ID)) {
      // –ú–´ —Å—Ç—Ä–µ–ª—è–µ–º –ø–æ enemyField
      const cell = enemyField.children[idx];
      if (cell) {
        cell.classList.remove('pending');
        if (d.result === 'miss') {
          cell.classList.add('miss');
          cell.textContent = '‚Ä¢';
        } else if (d.result === 'hit') {
          cell.classList.add('hit');
          cell.textContent = '√ó';
        } else if (d.result === 'sunk') {
          cell.classList.add('sunk');
          cell.textContent = '√ó';
        }
      }

      if (d.sunkShip && Array.isArray(d.sunkShip.cells)) {
        markDotsAroundShip(enemyField, d.sunkShip.cells);
      }

    } else {
      // –ø–æ –ù–ê–° —Å—Ç—Ä–µ–ª—è—é—Ç (myField)
      const cell = myField.children[idx];
      if (cell) {
        if (d.result === 'miss') {
          cell.classList.add('miss');
          cell.textContent = '‚Ä¢';
        } else if (d.result === 'hit') {
          cell.classList.add('hit');
          cell.textContent = '√ó';
        } else if (d.result === 'sunk') {
          cell.classList.add('sunk');
          cell.textContent = '√ó';
        }
      }

      if (d.sunkShip && Array.isArray(d.sunkShip.cells)) {
        markDotsAroundShip(myField, d.sunkShip.cells);
      }
    }

    currentTurn = d.newTurn;
    const myTurnNow = !d.finished && String(currentTurn) === String(PLAYER_ID);
    turnLabel.innerText = d.finished ? '‚Äî' : String(currentTurn || '‚Äî');

    const turnText = d.finished
      ? ''
      : (myTurnNow ? ' –¢–≤–æ–π —Ö–æ–¥.' : ' –•–æ–¥ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞.');
    updateStatus(`–†–µ–∑—É–ª—å—Ç–∞—Ç: ${d.result} (${d.x},${d.y}).${turnText}`);
    updateTurnBanner();

    if (d.finished) {
      matchFinished = true;
      updateStatus('–ú–∞—Ç—á –∑–∞–≤–µ—Ä—à—ë–Ω. –ü–æ–±–µ–¥–∏—Ç–µ–ª—å: ' + (d.winner || '‚Äî'));
      showEndModal(d.winner);
      updateTurnBanner();
    }
  });

  socket.on('match_finished', d => {
    matchFinished = true;
    updateStatus('–ú–∞—Ç—á –∑–∞–≤–µ—Ä—à—ë–Ω. –ü–æ–±–µ–¥–∏—Ç–µ–ª—å: ' + (d.winner || '‚Äî'));
    showEndModal(d.winner);
    updateTurnBanner();
  });

  socket.on('rematch_started', d => {
    if (!d) return;

    currentMatchId = d.matchId;
    currentTurn    = d.turn;
    matchLabel.innerText = currentMatchId;
    turnLabel.innerText  = String(currentTurn || '‚Äî');

    enemyField.querySelectorAll('.cell').forEach(c => {
      c.className = 'cell';
      c.innerHTML = '';
    });
    myField.querySelectorAll('.cell').forEach(c => {
      c.className = 'cell';
      c.innerHTML = '';
    });

    clearAll();
    hideEndModal();
    matchFinished = false;

    updateStatus('–†–µ–≤–∞–Ω—à! –†–∞—Å—Å—Ç–∞–≤—å –∫–æ—Ä–∞–±–ª–∏ –∏ –Ω–∞–∂–º–∏ –ì–æ—Ç–æ–≤');
    updateTurnBanner();
  });

  socket.on('rematch_pending',()=>{
    updateStatus('–ñ–¥—ë–º —Ä–µ—à–µ–Ω–∏–µ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞ –ø–æ —Ä–µ–≤–∞–Ω—à—É...');
  });

  socket.on('rematch_vote',d=>{
    updateStatus('–ò–≥—Ä–æ–∫ –∑–∞–ø—Ä–æ—Å–∏–ª —Ä–µ–≤–∞–Ω—à');
  });

  socket.on('player_left',d=>{
    updateStatus('–ò–≥—Ä–æ–∫ –≤—ã—à–µ–ª –∏–∑ –º–∞—Ç—á–∞');
    matchFinished=true;
    currentMatchId=null;
    matchLabel.innerText='‚Äî';
    updateTurnBanner();
  });

  socket.on('purchase_result',data=>{
    if(!data) return;
    if(data.ok){
      if(Array.isArray(data.ownedSkins)) ownedSkins=data.ownedSkins;
      else if(data.skinId && !ownedSkins.includes(data.skinId)) ownedSkins.push(data.skinId);
      localStorage.setItem('owned_skins',JSON.stringify(ownedSkins));
      equippedSkin=data.skinId || equippedSkin;
      localStorage.setItem('equipped_skin',equippedSkin);
      updateStatus('–ü–æ–∫—É–ø–∫–∞ —É—Å–ø–µ—à–Ω–∞! –°–∫–∏–Ω –Ω–∞–¥–µ—Ç.');
      renderShopModalContent();
      renderAll();
    }else{
      updateStatus('–û—à–∏–±–∫–∞ –ø–æ–∫—É–ø–∫–∏: ' + (data.error || 'unknown'));
      if(data.error==='not_enough_stars'){
        if(confirm('–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç stars. –û—Ç–∫—Ä—ã—Ç—å –º–∞–≥–∞–∑–∏–Ω?')){
          if(WebApp && WebApp.openLink) WebApp.openLink(SHOP_URL);
          else window.open(SHOP_URL,'_blank');
        }
      }
    }
  });

  socket.on('error',e=>logDbg('server error: ' + JSON.stringify(e)));
}

/* ====== –∫–Ω–æ–ø–∫–∏ (mat—Åh) ====== */
quickPlayBtn.addEventListener('click',()=>{
  initSocket();
  socket.emit('find_match',{playerId:PLAYER_ID});
  updateStatus('–í –ø–æ–∏—Å–∫–µ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞...');
  updateTurnBanner();
});

createMatchBtn.addEventListener('click',()=>{
  initSocket();
  socket.emit('create_match',{playerId:PLAYER_ID});
  updateStatus('–°–æ–∑–¥–∞–Ω–∏–µ –º–∞—Ç—á–∞...');
});

joinMatchBtn.addEventListener('click',()=>{
  const id=matchIdInput.value.trim();
  if(!id){ updateStatus('–í–≤–µ–¥–∏—Ç–µ match id'); return; }
  initSocket();
  socket.emit('join_match',{matchId:id,playerId:PLAYER_ID});
  updateStatus('–ó–∞–ø—Ä–æ—à–µ–Ω–æ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ...');
});

leaveBtn.addEventListener('click',()=>{
  if(!socket) initSocket();
  socket.emit('leave',{playerId:PLAYER_ID,matchId:currentMatchId});
  currentMatchId=null;
  matchLabel.innerText='‚Äî';
  matchFinished=false;
  updateStatus('–í—ã –≤—ã—à–ª–∏ –∏–∑ –º–∞—Ç—á–∞');
  updateTurnBanner();
});

/* Ready: —Ç–æ–ª—å–∫–æ –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ä–∞—Å—Å—Ç–∞–Ω–æ–≤–∫–∏ */
readyBtn.addEventListener('click', () => {
  if (!allPlaced()) {
    updateStatus('–°–Ω–∞—á–∞–ª–∞ —Ä–∞–∑–º–µ—Å—Ç–∏ –≤—Å–µ –∫–æ—Ä–∞–±–ª–∏');
    return;
  }
  initSocket();
  socket.emit('place_ships', {
    matchId: currentMatchId,
    playerId: PLAYER_ID,
    ships: placed
  });
  updateStatus('–†–∞—Å—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞');
});

/* Resign: –ø—Ä–æ—Å—Ç–æ –≤—ã–π—Ç–∏ –∏–∑ –º–∞—Ç—á–∞ */
resignBtn.addEventListener('click', () => {
  if (!socket) initSocket();
  if (currentMatchId) {
    socket.emit('leave', { playerId: PLAYER_ID, matchId: currentMatchId });
  }
  currentMatchId = null;
  matchLabel.innerText = '‚Äî';
  matchFinished = false;
  updateStatus('–í—ã –≤—ã—à–ª–∏ –∏–∑ –º–∞—Ç—á–∞');
  updateTurnBanner();
});

/* ====== –ú–∞–≥–∞–∑–∏–Ω (—Ç–æ–ª—å–∫–æ –º–æ–¥–∞–ª–∫–∞) ====== */
shopBtn.addEventListener('click',openShopModal);
shopClose.addEventListener('click',closeShopModal);
shopModalBuyAll.addEventListener('click',()=>{
  if(WebApp && WebApp.openLink){
    try{ WebApp.openLink(SHOP_URL); return; }catch(e){}
  }
  window.open(SHOP_URL,'_blank');
});

function openShopModal(){
  renderShopModalContent();
  shopModal.style.display='flex';
}
function closeShopModal(){
  shopModal.style.display='none';
}

function renderShopModalContent(){
  shopModalContent.innerHTML='';
  SKINS.forEach(skin=>{
    const row=document.createElement('div');
    row.style.display='flex';
    row.style.alignItems='center';
    row.style.gap='8px';
    row.style.padding='8px';
    row.style.borderRadius='8px';

    const img=document.createElement('img');
    img.src=skin.parts.head;
    img.style.width='72px';
    img.style.height='44px';
    img.style.objectFit='cover';
    img.style.borderRadius='6px';
    row.appendChild(img);

    const info=document.createElement('div');
    info.style.flex='1';
    info.innerHTML = `<div style="font-weight:700">${skin.name}</div><div class="small">–¶–µ–Ω–∞: ${skin.price} stars</div>`;
    row.appendChild(info);

    const btn=document.createElement('button');
    btn.className='ship-btn';
    const owned=ownedSkins.includes(skin.id);
    btn.innerText = owned ? (equippedSkin===skin.id ? '–ù–∞–¥–µ—Ç–æ' : '–ù–∞–¥–µ—Ç—å') : '–ö—É–ø–∏—Ç—å';
    btn.onclick = ()=>{
      if(owned){
        equipSkinLocal(skin.id);
        renderShopModalContent();
      }else{
        buySkinRequest(skin.id);
      }
    };
    row.appendChild(btn);

    shopModalContent.appendChild(row);
  });
}

function equipSkinLocal(skinId){
  if(!ownedSkins.includes(skinId)) return;
  equippedSkin=skinId;
  localStorage.setItem('equipped_skin',equippedSkin);
  if(socket && socket.connected) socket.emit('equip_skin',{playerId:PLAYER_ID,skinId});
  renderShopModalContent();
  renderAll();
}

function buySkinRequest(skinId){
  if(!socket) initSocket();
  if(socket && socket.connected){
    socket.emit('buy_skin',{playerId:PLAYER_ID,skinId});
    updateStatus('–ü–æ–∫—É–ø–∫–∞: –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä...');
    return;
  }
  updateStatus('–û—Ç–∫—Ä—ã–≤–∞—é –º–∞–≥–∞–∑–∏–Ω –≤ –±–æ—Ç–µ');
  if(WebApp && WebApp.openLink) WebApp.openLink(SHOP_URL);
  else window.open(SHOP_URL,'_blank');
}

/* ====== Init ====== */
function initUI(){
  buildFields();
  renderShipsPanel();
  renderAll();
  modeLabel.innerText='railway';
  updateStatus('–ì–æ—Ç–æ–≤–æ ‚Äî –Ω–∞–∂–º–∏ –ò–≥—Ä–∞—Ç—å –∏–ª–∏ —Å–æ–∑–¥–∞–π –º–∞—Ç—á');
  dbg.style.display='none';
  updateTurnBanner();
}
initUI();

/* –∑–∞–≥—Ä—É–∑–∫–∞ –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Å–∫–∏–Ω–æ–≤ */
(function loadLocalShop(){
  const lsOwned=localStorage.getItem('owned_skins');
  if(lsOwned) try{ownedSkins=JSON.parse(lsOwned);}catch(e){}
  const eq=localStorage.getItem('equipped_skin');
  if(eq) equippedSkin=eq;
})();
</script>
</body>
  </html>
