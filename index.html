<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SeaStrike</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:sans-serif; padding:16px; background:#e3f2fd; }
    .screen { display:none; }
    #screen-menu { display:block; }
    .btn { display:block; width:100%; padding:14px; margin:8px 0; border:none; border-radius:10px; background:#1976d2; color:white; font-weight:bold; }
    .grid { display:grid; grid-template-columns:repeat(10,1fr); gap:2px; margin:16px 0; }
    .cell { aspect-ratio:1; background:#bbdefb; border-radius:4px; }
    .ships-panel { display:flex; flex-wrap:wrap; gap:8px; margin:16px 0; }
    .ship { background:#2196f3; width:24px; height:24px; margin:2px; border-radius:4px; }
  </style>
</head>
<body>
  <div id="screen-menu" class="screen">
    <h2>SeaStrike</h2>
    <button class="btn" onclick="startMatch()">‚ñ∂ –ù–∞—á–∞—Ç—å –º–∞—Ç—á</button>
  </div>

  <div id="screen-placement" class="screen">
    <h3>–†–∞—Å—Å—Ç–∞–≤—å—Ç–µ –∫–æ—Ä–∞–±–ª–∏</h3>
    <div class="ships-panel" id="shipsPanel"></div>
    <div class="grid" id="myField"></div>
    <button class="btn" id="readyBtn" onclick="submitPlacement()" disabled>‚úÖ –ì–æ—Ç–æ–≤–æ</button>
  </div>

  <div id="screen-waiting" class="screen">
    <h3>üïó –û–∂–∏–¥–∞–Ω–∏–µ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞‚Ä¶</h3>
  </div>

  <div id="screen-match" class="screen">
    <div id="status">üéØ –í–∞—à —Ö–æ–¥</div>
    <div class="grid" id="enemyField"></div>
    <div class="grid" id="myFieldBattle"></div>
  </div>

  <script>
    if (!window.Telegram?.WebApp) { alert('–û—Ç–∫—Ä–æ–π—Ç–µ –≤ Telegram!'); throw 0; }
    const WebApp = Telegram.WebApp; WebApp.expand();

    const user = WebApp.initDataUnsafe?.user;
    if (!user) WebApp.close();
    const userId = user.id;

    let myShips = [];

    // ‚úÖ MOCK BACKEND ‚Äî —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ —Å–µ—Ä–≤–µ—Ä–∞
    async function mockFetch(path, data = {}) {
      return new Promise(resolve => {
        const workerCode = `(${(() => {
          ${document.querySelector('script').textContent}
        })})();`;
        const blob = new Blob([workerCode], { type: 'application/javascript' });
        const url = URL.createObjectURL(blob);
        const worker = new Worker(url);
        worker.onmessage = e => {
          resolve(e.data.result);
          worker.terminate();
          URL.revokeObjectURL(url);
        };
        worker.postMessage({ url: 'http://mock' + path, method: 'POST', body: data });
      });
    }

    function showScreen(id) {
      document.querySelectorAll('.screen').forEach(s => s.style.display = 'none');
      document.getElementById(id).style.display = 'block';
    }

    function startMatch() {
      showScreen('screen-placement');
      initPlacement();
    }

    function initPlacement() {
      const panel = document.getElementById('shipsPanel');
      panel.innerHTML = '';
      [4,3,3,2,2,2,1,1,1,1].forEach(size => {
        const div = document.createElement('div');
        div.className = 'ship';
        div.dataset.size = size;
        div.draggable = true;
        div.ondragstart = e => e.dataTransfer.setData('size', size);
        panel.appendChild(div);
      });

      const field = document.getElementById('myField');
      field.innerHTML = '';
      for (let i = 0; i < 100; i++) {
        const cell = document.createElement('div');
        cell.className = 'cell';
        cell.dataset.idx = i;
        cell.ondrop = e => {
          e.preventDefault();
          const size = e.dataTransfer.getData('size');
          placeShip(i, parseInt(size));
        };
        cell.ondragover = e => e.preventDefault();
        field.appendChild(cell);
      }
    }

    function placeShip(start, size) {
      myShips.push({ start, size });
      if (myShips.reduce((s, sh) => s + sh.size, 0) === 20) {
        document.getElementById('readyBtn').disabled = false;
      }
    }

    async function submitPlacement() {
      await mockFetch('/match/random/join', { telegram_id: userId });
      await mockFetch('/match/demo-123/place-ships', { telegram_id: userId, ships: myShips });
      showScreen('screen-waiting');
      setTimeout(async () => {
        await mockFetch('/match/demo-123/wait-ready', { telegram_id: userId });
        showScreen('screen-match');
        initBattle();
      }, 1000);
    }

    function initBattle() {
      ['enemyField', 'myFieldBattle'].forEach(id => {
        const f = document.getElementById(id);
        f.innerHTML = '';
        for (let i = 0; i < 100; i++) {
          const c = document.createElement('div');
          c.className = 'cell';
          if (id === 'enemyField') c.onclick = () => attack(i);
          f.appendChild(c);
        }
      });
    }

    async function attack(idx) {
      const result = await mockFetch('/match/demo-123/attack', {
        telegram_id: userId,
        x: idx % 10,
        y: Math.floor(idx / 10)
      });
      const cell = document.querySelectorAll('#enemyField .cell')[idx];
      cell.style.background = result.hit === 0 ? '#eceff1' : result.hit === 1 ? '#ffccbc' : '#f44336';
      document.getElementById('status').innerText = result.finished ? 
        (result.winner_id ? 'üèÜ –ü–æ–±–µ–¥–∞!' : 'üíÄ –ü–æ—Ä–∞–∂–µ–Ω–∏–µ') : 
        'üéØ –•–æ–¥ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞';
    }
  </script>
</body>
</html>
