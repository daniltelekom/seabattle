
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>SeaStrike ‚Äî MiniApp</title>

  <!-- Socket.IO client -->
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <!-- Telegram WebApp SDK (–µ—Å–ª–∏ –æ—Ç–∫—Ä–æ—é—Ç –≤ TG) -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --accent:#1976d2;
      --bg:#e9f4ff;
      --card:#fff;
      --cell:#e8f3ff;
      --miss:#eceff1;
      --hit:#f44336;
      --occupied:#2b9cff;
      --pending:#ffd54f;
      --sunk:#b71c1c;
      --ship-img-size:64px;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:system-ui,Roboto,Arial;margin:10px;background:var(--bg);color:#072146;display:flex;flex-direction:column;gap:10px;min-height:100vh}
    .header{display:flex;justify-content:space-between;align-items:center;gap:8px}
    .panel{background:var(--card);padding:10px;border-radius:12px;box-shadow:0 6px 18px rgba(2,20,60,0.06)}
    .layout{display:grid;grid-template-columns:1fr 320px;gap:12px}
    @media (max-width:920px){ .layout{grid-template-columns:1fr} }
    .field-wrap{display:flex;flex-direction:column;align-items:center;gap:8px}
    .big-grid{width:100%;max-width:560px;display:grid;grid-template-columns:repeat(10,1fr);gap:4px}
    .small-grid{width:260px;display:grid;grid-template-columns:repeat(10,1fr);gap:3px}
    .cell{aspect-ratio:1;background:var(--cell);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:12px;user-select:none;overflow:hidden;position:relative}
    .cell.occupied{color:white}
    .cell.miss{background:var(--miss)}
    .cell.hit{background:var(--hit);color:white}
    .cell.pending{background:var(--pending)}
    .cell.sunk{background:var(--sunk);color:white}
    .cell img.part {
      width: var(--ship-img-size);
      height: var(--ship-img-size);
      object-fit: contain;
      pointer-events: none;
      user-select: none;
      display:block;
      margin:auto;
    }
    .rotated { transform-origin: center center; transform: rotate(90deg); }
    .ships-panel{display:flex;flex-wrap:wrap;gap:8px}
    .ship-btn{padding:8px 10px;border-radius:8px;background:#2196f3;color:#fff;border:none;min-width:42px}
    .ship-btn.selected{outline:3px solid #ffca28}
    .footer{position:fixed;left:10px;right:10px;bottom:10px;display:flex;gap:8px;z-index:20}
    .footer .panel{flex:1;display:flex;justify-content:space-between;align-items:center;padding:10px}
    .info{font-size:13px;color:#263238}
    .small{font-size:12px;color:#3b4752}
    #dbg{position:fixed;right:8px;top:8px;background:rgba(0,0,0,0.75);color:#fff;padding:6px 8px;border-radius:6px;display:none;max-width:46%;white-space:pre-wrap;z-index:60;font-size:12px}
    .shop-btn{background:linear-gradient(90deg,#ffb74d,#ff8a65);border:none;color:#fff;padding:8px 10px;border-radius:8px}
    input, select{padding:8px;border-radius:8px;border:1px solid #ddd}
    .compact{font-size:12px}
    .label-muted{font-size:12px;color:#607d8b}
    .enemy-title{font-weight:700;margin-bottom:6px}
    .sunk-preview { box-shadow: 0 0 0 3px rgba(255,215,0,0.9), 0 8px 30px rgba(0,0,0,0.15); transform: scale(1.06); transition: transform .28s ease, box-shadow .28s ease; border-radius:6px; }
    @keyframes reveal-sunk { 0% { opacity: 0; transform: scale(0.9); } 60% { opacity: 1; transform: scale(1.04); } 100% { opacity: 1; transform: scale(1); } }
    .sunk-reveal { animation: reveal-sunk .34s cubic-bezier(.2,.9,.3,1); }
  </style>
</head>
<body>
  <div class="header">
    <div>
      <h2>SeaStrike ‚Äî MiniApp</h2>
      <div class="small">–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –º–æ—Ä—Å–∫–æ–π –±–æ–π ‚Äî –∫–ª–∏–∫–∞–π –ø–æ –ø–æ–ª—é –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞, —á—Ç–æ–±—ã —Å—Ç—Ä–µ–ª—è—Ç—å.</div>
    </div>
    <div class="small">PlayerID: <span id="playerIdLabel">‚Äî</span></div>
  </div>
  <div class="layout">
    <div class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div class="ships-panel" id="shipsPanel"></div>
        <div style="display:flex;gap:8px">
          <button id="rotateBtn" class="ship-btn">–ü–æ–≤–µ—Ä–Ω—É—Ç—å (H)</button>
          <button id="autoBtn" class="ship-btn">–ê–≤—Ç–æ</button>
        </div>
      </div>

      <div id="fieldArea" class="field-wrap" style="margin-top:12px">
        <div>
          <div class="enemy-title">–ü–æ–ª–µ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞ (–∫–ª–∏–∫ ‚Äî —Å—Ç—Ä–µ–ª—è—Ç—å)</div>
          <div id="enemyField" class="big-grid" aria-label="–ü–æ–ª–µ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞"></div>
        </div>

        <div style="margin-top:12px">
          <div class="label-muted">–í–∞—à–µ –ø–æ–ª–µ</div>
          <div id="myField" class="small-grid" aria-label="–í–∞—à–µ –ø–æ–ª–µ"></div>
        </div>
      </div>

      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px">
        <div id="status" class="small">–†–∞—Å—Å—Ç–∞–≤—å—Ç–µ –∫–æ—Ä–∞–±–ª–∏ –∏ –Ω–∞–∂–º–∏—Ç–µ –ì–æ—Ç–æ–≤.</div>
        <div style="display:flex;gap:8px">
          <button id="undoBtn" class="ship-btn">‚Ü∂ –û—Ç–º–µ–Ω–∏—Ç—å</button>
          <button id="eraseModeBtn" class="ship-btn">–£–¥–∞–ª–µ–Ω–∏–µ: –≤—ã–∫–ª</button>
        </div>
      </div>
    </div>

    <div>
      <div class="panel" style="display:flex;flex-direction:column;gap:10px">
        <div style="display:flex;gap:8px;align-items:center">
          <button id="createMatchBtn" class="ship-btn">–°–æ–∑–¥–∞—Ç—å –º–∞—Ç—á</button>
          <input id="matchIdInput" placeholder="match id –¥–ª—è join" style="flex:1"/>
          <button id="joinMatchBtn" class="ship-btn">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
        </div>

        <div style="display:flex;gap:8px">
          <button id="findBtn" class="ship-btn">–ù–∞–π—Ç–∏ –∏–≥—Ä—É</button>
          <button id="leaveBtn" class="ship-btn">–í—ã–π—Ç–∏</button>
          <button id="shopBtn" class="shop-btn">–ú–∞–≥–∞–∑–∏–Ω</button>
        </div>

        <div style="display:flex;flex-direction:column;gap:6px" class="compact">
          <div class="info">Mode: <span id="modeLabel">railway</span></div>
          <div class="info">Match: <span id="matchLabel">‚Äî</span></div>
          <div class="info">Turn: <span id="turnLabel">‚Äî</span></div>
          <div class="info">Rating: <span id="ratingLabel">1000</span></div>
        </div>

        <hr/>

        <div class="info"><b>–ú–∞–≥–∞–∑–∏–Ω</b></div>
        <div id="shopCards" style="display:flex;flex-direction:column;gap:8px"></div>

      </div>
    </div>
  </div>

  <div id="dbg">DBG</div>

  <div class="footer">
    <div class="panel">
      <div class="info">–ü–æ–¥–¥–µ—Ä–∂–∫–∞: Railway (online socket)</div>
      <div style="display:flex;gap:8px">
        <button id="readyBtn" class="ship-btn">‚úÖ –ì–æ—Ç–æ–≤</button>
        <button id="resignBtn" class="ship-btn">–°–¥–∞—Ç—å—Å—è</button>
      </div>
    </div>
  </div>

  <!-- Shop modal (–ø–æ–¥–∞—Ä–æ–∫) -->
  <div id="shopModal" style="display:none;position:fixed;left:0;top:0;right:0;bottom:0;align-items:center;justify-content:center;background:rgba(0,0,0,0.5);z-index:1000;">
    <div style="width:92%;max-width:420px;background:white;border-radius:14px;padding:14px;position:relative;text-align:center;box-shadow:0 10px 30px rgba(2,20,60,0.2);">
      <button id="shopClose" style="position:absolute;right:10px;top:10px;background:transparent;border:none;font-size:18px;cursor:pointer;">‚úï</button>
      <div style="font-size:18px;font-weight:700;margin-bottom:8px;">üéÅ –ú–∞–≥–∞–∑–∏–Ω —Å–∫–∏–Ω–æ–≤</div>
      <div id="shopModalContent" style="display:flex;flex-direction:column;gap:8px;max-height:60vh;overflow:auto;padding:6px;"></div>
      <div style="margin-top:10px;">
        <button id="shopModalBuyAll" class="ship-btn" style="background:linear-gradient(90deg,#4caf50,#388e3c);">–ö—É–ø–∏—Ç—å/–û—Ç–∫—Ä—ã—Ç—å –≤ –±–æ—Ç–µ</button>
      </div>
    </div>
  </div>

  <script>
/* ================== –ù–∞—Å—Ç—Ä–æ–π–∫–∏ (–∑–∞–º–µ–Ω–∏) ================== */
const SOCKET_URL = "https://seabattle-server-production.up.railway.app"; // <- –ø—Ä–æ–≤–µ—Ä—å: –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å https://
const SHOP_URL = "https://t.me/YourBotOrShop";

/* ================== –°–∫–∏–Ω—ã ‚Äî —É–∫–∞–∂–∏ –ø—É—Ç–∏ –∫ –∫–∞—Ä—Ç–∏–Ω–∫–∞–º ================== */
const SKINS = [
  {
    id: 'blue',
    name: 'Blue Steel',
    price: 50,
    parts: {
      head: 'assets/skins/blue_head.png',
      body: 'assets/skins/blue_body.png',
      tail: 'assets/skins/blue_tail.png',
      single: 'assets/skins/blue_single.png'
    }
  },
  {
    id: 'red',
    name: 'Crimson',
    price: 75,
    parts: {
      head: 'assets/skins/red_head.png',
      body: 'assets/skins/red_body.png',
      tail: 'assets/skins/red_tail.png',
      single: 'assets/skins/red_single.png'
    }
  },
  {
    id: 'gold',
    name: 'Gold',
    price: 150,
    parts: {
      head: 'assets/skins/gold_head.png',
      body: 'assets/skins/gold_body.png',
      tail: 'assets/skins/gold_tail.png',
      single: 'assets/skins/gold_single.png'
    }
  }
];

/* ================== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–≥—Ä–æ–∫–∞ ================== */
const WebApp = window.Telegram?.WebApp || null;
const initUser = WebApp?.initDataUnsafe?.user || { id: Math.floor(Math.random()*1e6), username: 'local_test' };
const PLAYER_ID = String(initUser.id);
const PLAYER_NAME = initUser.username || ('p' + PLAYER_ID);
document.getElementById('playerIdLabel').innerText = PLAYER_ID;

/* ================== –≠–ª–µ–º–µ–Ω—Ç—ã UI ================== */
const enemyField = document.getElementById('enemyField');
const myField = document.getElementById('myField');
const shipsPanel = document.getElementById('shipsPanel');
const rotateBtn = document.getElementById('rotateBtn');
const autoBtn = document.getElementById('autoBtn');
const undoBtn = document.getElementById('undoBtn');
const eraseModeBtn = document.getElementById('eraseModeBtn');
const readyBtn = document.getElementById('readyBtn');
const resignBtn = document.getElementById('resignBtn');
const statusEl = document.getElementById('status');
const createMatchBtn = document.getElementById('createMatchBtn');
const joinMatchBtn = document.getElementById('joinMatchBtn');
const findBtn = document.getElementById('findBtn');
const leaveBtn = document.getElementById('leaveBtn');
const matchIdInput = document.getElementById('matchIdInput');
const matchLabel = document.getElementById('matchLabel');
const turnLabel = document.getElementById('turnLabel');
const modeLabel = document.getElementById('modeLabel');
const shopBtn = document.getElementById('shopBtn');
const shopCards = document.getElementById('shopCards');
const dbg = document.getElementById('dbg');
const shopModalContent = document.getElementById('shopModalContent');

/* ================== State ================== */
let socket = null;
let currentMatchId = null;
let currentTurn = null;

/* ================== Placement state ================== */
const SHIP_SIZES = [4,3,3,2,2,2,1,1,1,1];
function group(arr){ const out={}; arr.forEach(s=>out[s]=(out[s]||0)+1); return out; }
let shipsPool = group(SHIP_SIZES);
let placed = [];
let nextShipId = 1;
let selectedSize = null;
let orientation = 'H';
let eraseMode = false;

/* ================== Shop state (local fallback) ================== */
let ownedSkins = JSON.parse(localStorage.getItem('owned_skins') || '["blue"]');
let equippedSkin = localStorage.getItem('equipped_skin') || 'blue';

/* ================== Helpers ================== */
function logDbg(msg){ if(!dbg) return; dbg.style.display='block'; try{ dbg.innerText = typeof msg === 'string' ? msg : JSON.stringify(msg, null, 2); }catch(e){ dbg.innerText = String(msg); } }
function coords(idx){ return { x: idx % 10, y: Math.floor(idx / 10) }; }
function cellIndex(x,y){ return y*10 + x; }
function cellsFor(start,size,orient){
  const p = coords(start); const cells=[];
  if(orient==='H'){ for(let k=0;k<size;k++){ const nx=p.x+k; if(nx>9) return null; cells.push(cellIndex(nx,p.y)); } }
  else { for(let k=0;k<size;k++){ const ny=p.y+k; if(ny>9) return null; cells.push(cellIndex(p.x,ny)); } }
  return cells;
}
function adjacentCellsOf(c){ const {x,y}=coords(c); const out=[]; for(let dy=-1;dy<=1;dy++) for(let dx=-1;dx<=1;dx++){ const nx=x+dx, ny=y+dy; if(nx>=0&&nx<10&&ny>=0&&ny<10) out.push(cellIndex(nx,ny)); } return out; }
function overlapsOrAdjacent(cells){ const occ = new Set(placed.flatMap(s=>s.cells)); for(const c of cells){ if(occ.has(c)) return {overlap:true}; for(const n of adjacentCellsOf(c)) if(occ.has(n)) return {adjacent:true,at:n}; } return null; }
function getSkinById(id){ return SKINS.find(s => s.id === id) || SKINS[0]; }

/* ================== Build grids ================== */
function buildFields(){
  enemyField.innerHTML = '';
  for(let i=0;i<100;i++){
    const c = document.createElement('div');
    c.className = 'cell';
    c.dataset.idx = i;
    c.addEventListener('click', onEnemyClick);
    c.addEventListener('touchend', function(e){ e.preventDefault(); onEnemyClick.call(this,e); });
    enemyField.appendChild(c);
  }
  myField.innerHTML = '';
  for(let i=0;i<100;i++){
    const c = document.createElement('div');
    c.className = 'cell';
    c.dataset.idx = i;
    c.addEventListener('click', onMyCellClick);
    c.addEventListener('touchend', function(e){ e.preventDefault(); onMyCellClick.call(this,e); });
    myField.appendChild(c);
  }
}

/* ================== Render ships panel & my ships with images ================== */
function renderShipsPanel(){
  shipsPanel.innerHTML='';
  const unique = Array.from(new Set(SHIP_SIZES)).sort((a,b)=>b-a);
  unique.forEach(size=>{
    const left = shipsPool[size] || 0;
    const btn = document.createElement('button');
    btn.className = 'ship-btn' + (selectedSize===size ? ' selected' : '');
    btn.type='button';
    btn.innerText = `${size} √ó ${left}`;
    function handler(e){ e.preventDefault(); if(left<=0){ updateStatus('–ù–µ—Ç —Ç–∞–∫–∏—Ö –∫–æ—Ä–∞–±–ª–µ–π'); return; } selectedSize = (selectedSize===size)?null:size; renderShipsPanel(); updateStatus(); }
    btn.addEventListener('click', handler);
    btn.addEventListener('touchend', function(e){ e.preventDefault(); handler(e); });
    shipsPanel.appendChild(btn);
  });
}

function renderAll(){
  // myField
  document.querySelectorAll('#myField .cell').forEach(c=>{ c.classList.remove('occupied','hit','miss','pending','sunk'); c.style.transform=''; c.innerHTML=''; });
  const skin = getSkinById(equippedSkin);
  placed.forEach(ship => {
    const parts = ship.cells;
    const size = ship.size;
    parts.forEach((cellIdx, i) => {
      const el = myField.children[cellIdx];
      if(!el) return;
      let partName = 'body';
      if(size === 1) partName = 'single';
      else if(i === 0) partName = 'head';
      else if(i === parts.length - 1) partName = 'tail';
      const url = skin.parts && skin.parts[partName];
      if(url){
        const img = document.createElement('img');
        img.className = 'part' + (ship.orientation === 'V' ? ' rotated' : '');
        img.draggable = false;
        img.src = url;
        el.appendChild(img);
      } else {
        el.style.background = 'var(--occupied)';
      }
      el.classList.add('occupied');
    });
  });

  renderShipsPanel();
  readyBtn.disabled = !allPlaced();
  updateStatus();
}

function allPlaced(){ return Object.values(shipsPool).every(v=>v===0); }

function placeShipAt(startIdx,size,orient){
  const cells = cellsFor(startIdx,size,orient);
  if(!cells) return { ok:false, reason:'out' };
  const bad = overlapsOrAdjacent(cells);
  if(bad){ if(bad.overlap) return {ok:false,reason:'overlap'}; if(bad.adjacent) return {ok:false,reason:'adjacent'}; }
  const ship = { id: nextShipId++, size, start: startIdx, orientation: orient, cells };
  placed.push(ship);
  shipsPool[size] = (shipsPool[size]||0) - 1;
  renderAll();
  return { ok:true, ship };
}
function findShipByCell(idx){ return placed.find(s=>s.cells.includes(idx)); }
function removeShipById(id){ const i = placed.findIndex(s=>s.id===id); if(i===-1) return false; const s = placed[i]; shipsPool[s.size] = (shipsPool[s.size]||0)+1; placed.splice(i,1); renderAll(); return true; }

function updateStatus(msg){
  if(msg){ statusEl.innerText = msg; logDbg(msg); return; }
  if(allPlaced()) statusEl.innerText = '–í—Å–µ –∫–æ—Ä–∞–±–ª–∏ —Ä–∞—Å—Å—Ç–∞–≤–ª–µ–Ω—ã ‚Äî –Ω–∞–∂–º–∏ –ì–æ—Ç–æ–≤';
  else if(selectedSize) statusEl.innerText = `–í—ã–±—Ä–∞–Ω–æ ${selectedSize} (–æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è ${orientation})`;
  else statusEl.innerText = '–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ—Ä–∞–±–ª—å';
}

/* UI placement handlers */
function onMyCellClick(e){
  const el = e.currentTarget || this; const idx = parseInt(el.dataset.idx);
  if(eraseMode){ const ship = findShipByCell(idx); if(ship){ removeShipById(ship.id); updateStatus('–ö–æ—Ä–∞–±–ª—å —É–¥–∞–ª—ë–Ω'); } else updateStatus('–ù–µ—Ç –∫–æ—Ä–∞–±–ª—è'); return; }
  if(!selectedSize){ updateStatus('–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ—Ä–∞–±–ª—å'); return; }
  const res = placeShipAt(idx, selectedSize, orientation);
  if(!res.ok){ if(res.reason==='out') updateStatus('–í—ã—Ö–æ–¥ –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã'); else if(res.reason==='overlap') updateStatus('–ü–µ—Ä–µ–∫—Ä—ã—Ç–∏–µ'); else if(res.reason==='adjacent') updateStatus('–†—è–¥–æ–º –¥—Ä—É–≥–æ–π –∫–æ—Ä–∞–±–ª—å'); else updateStatus('–ù–µ–ª—å–∑—è –ø–æ—Å—Ç–∞–≤–∏—Ç—å'); }
  else { updateStatus('–ö–æ—Ä–∞–±–ª—å –ø–æ—Å—Ç–∞–≤–ª–µ–Ω'); if((shipsPool[selectedSize]||0) <= 0) selectedSize = null; }
}

rotateBtn.addEventListener('click', ()=>{ orientation = (orientation==='H') ? 'V' : 'H'; rotateBtn.innerText = `–ü–æ–≤–µ—Ä–Ω—É—Ç—å (${orientation})`; updateStatus(); });
autoBtn.addEventListener('click', ()=>{ randomPlaceAll(); updateStatus('–ê–≤—Ç–æ-—Ä–∞—Å—Å—Ç–∞–Ω–æ–≤–∫–∞'); });
undoBtn.addEventListener('click', ()=>{ if(placed.length===0){ updateStatus('–ù–µ—á–µ–≥–æ –æ—Ç–º–µ–Ω—è—Ç—å'); return; } const last = placed.pop(); shipsPool[last.size] = (shipsPool[last.size]||0) + 1; renderAll(); updateStatus('–û—Ç–º–µ–Ω—ë–Ω –ø–æ—Å–ª–µ–¥–Ω–∏–π'); });
eraseModeBtn.addEventListener('click', ()=>{ eraseMode = !eraseMode; eraseModeBtn.innerText = `–£–¥–∞–ª–µ–Ω–∏–µ: ${eraseMode ? '–≤–∫–ª' : '–≤—ã–∫–ª'}`; });

function clearAll(){ placed=[]; shipsPool = group(SHIP_SIZES); nextShipId = 1; selectedSize=null; orientation='H'; eraseMode=false; eraseModeBtn.innerText='–£–¥–∞–ª–µ–Ω–∏–µ: –≤—ã–∫–ª'; renderAll(); }
function randomPlaceAll(){ clearAll(); const sizes=[...SHIP_SIZES].sort(()=>Math.random()-0.5); for(const s of sizes){ let tries=0,ok=false; while(tries<500&&!ok){ const start=Math.floor(Math.random()*100); const orient=Math.random()<0.5?'H':'V'; const cells=cellsFor(start,s,orient); if(cells && !overlapsOrAdjacent(cells)){ placed.push({ id: nextShipId++, size: s, start, orientation: orient, cells }); shipsPool[s] = (shipsPool[s]||0)-1; ok=true; } tries++; } if(!ok) return randomPlaceAll(); } renderAll(); }

/* ================== Enemy click: send shoot to server ================== */
function onEnemyClick(e){
  const el = e.currentTarget || this;
  const idx = parseInt(el.dataset.idx);
  if(!currentMatchId){ updateStatus('–ù–µ—Ç –º–∞—Ç—á–∞ ‚Äî —Å–æ–∑–¥–∞–π –∏–ª–∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Å—è'); return; }
  if(!currentTurn || String(currentTurn) !== String(PLAYER_ID)){ updateStatus('–°–µ–π—á–∞—Å –Ω–µ –≤–∞—à —Ö–æ–¥'); return; }
  if(el.classList.contains('miss') || el.classList.contains('hit') || el.classList.contains('sunk') || el.classList.contains('pending')){ updateStatus('–í—ã —É–∂–µ —Å—Ç—Ä–µ–ª—è–ª–∏ —Å—é–¥–∞'); return; }
  const { x, y } = coords(idx);
  if(!socket) initSocket();
  socket.emit('shoot', { matchId: currentMatchId, playerId: PLAYER_ID, x, y });
  el.classList.add('pending');
  updateStatus(`–í—ã—Å—Ç—Ä–µ–ª: ${x},${y} ‚Äî –∂–¥—ë–º –æ—Ç–≤–µ—Ç–∞`);
}

/* ================== Socket.IO integration ================== */
function initSocket(){
  if(socket && socket.connected) return;
  if(!SOCKET_URL || !SOCKET_URL.startsWith('http')){ updateStatus('–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π SOCKET_URL'); return; }
  try {
    socket = io(SOCKET_URL, { transports: ['websocket'] });
  } catch (err) {
    logDbg('socket init error: ' + err);
    return;
  }

  socket.on('connect', ()=>{ logDbg('socket connected: ' + socket.id); socket.emit('identify', { playerId: PLAYER_ID, username: PLAYER_NAME }); });
  socket.on('connect_error', (err)=>{ logDbg('connect_error: ' + (err && err.message ? err.message : err)); });
  socket.on('disconnect', (reason)=>{ logDbg('disconnect: ' + reason); });

  socket.on('profile', d => {
    if(!d) return;
    if(Array.isArray(d.ownedSkins)) { ownedSkins = d.ownedSkins; localStorage.setItem('owned_skins', JSON.stringify(ownedSkins)); }
    if(d.equippedSkin) { equippedSkin = d.equippedSkin; localStorage.setItem('equipped_skin', equippedSkin); }
    renderShopUI();
    renderAll();
  });

  socket.on('identified', d=> logDbg('identified ok'));

  socket.on('match_created', d=>{
    currentMatchId = d.matchId; matchLabel.innerText = currentMatchId; modeLabel.innerText = 'railway'; updateStatus('–ú–∞—Ç—á —Å–æ–∑–¥–∞–Ω: ' + currentMatchId);
  });

  socket.on('match_joined', d=>{
    currentMatchId = d.matchId; matchLabel.innerText = currentMatchId; modeLabel.innerText = 'railway'; updateStatus('–í –º–∞—Ç—á–µ: ' + currentMatchId);
  });

  socket.on('match_found', d=>{
    currentMatchId = d.matchId; matchLabel.innerText = currentMatchId; modeLabel.innerText = 'railway'; updateStatus('–ù–∞–π–¥–µ–Ω –º–∞—Ç—á: ' + currentMatchId);
  });

  socket.on('placement_update', d=> updateStatus('–ü—Ä–æ—Ç–∏–≤–Ω–∏–∫ –æ—Ç–ø—Ä–∞–≤–∏–ª —Ä–∞—Å—Å—Ç–∞–Ω–æ–≤–∫—É'));

  socket.on('match_started', d=>{
    currentMatchId = d.matchId;
    currentTurn = d.turn;
    turnLabel.innerText = String(currentTurn);
    updateStatus('–ú–∞—Ç—á –Ω–∞—á–∞–ª—Å—è ‚Äî —Ö–æ–¥: ' + d.turn);
    enemyField.querySelectorAll('.cell').forEach(c=> c.classList.remove('pending','miss','hit','sunk'));
    myField.querySelectorAll('.cell').forEach(c=> c.classList.remove('pending','miss','hit','sunk'));
    updateStatus(String(currentTurn) === String(PLAYER_ID) ? '–í–∞—à —Ö–æ–¥ ‚Äî –∫–ª–∏–∫–∞–π –ø–æ –ø–æ–ª—é –≤—Ä–∞–≥–∞' : '–•–æ–¥ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞ ‚Äî –æ–∂–∏–¥–∞–π—Ç–µ');
  });

  socket.on('shot_result', d=>{
    try{
      if(!d) return;
      const idx = cellIndex(d.x, d.y);
      if(String(d.shooter) === String(PLAYER_ID)){
        const cell = enemyField.children[idx];
        if(cell){
          cell.classList.remove('pending');
          if(d.result === 'miss') cell.classList.add('miss');
          else if(d.result === 'hit') cell.classList.add('hit');
          else if(d.result === 'sunk') cell.classList.add('sunk');
        }
        if(d.sunkShip && Array.isArray(d.sunkShip.cells)){
          const skinId = d.sunkShip.skinId || equippedSkin;
          drawShipOnGrid(enemyField, d.sunkShip.cells, d.sunkShip.orientation || 'H', skinId);
          previewSunkOnGrid(enemyField, d.sunkShip.cells, d.sunkShip.orientation || 'H', skinId);
        }
      } else {
        const cell = myField.children[idx];
        if(cell){
          if(d.result === 'miss') cell.classList.add('miss');
          else if(d.result === 'hit') cell.classList.add('hit');
          else if(d.result === 'sunk') cell.classList.add('sunk');
        }
        if(d.sunkShip && Array.isArray(d.sunkShip.cells)){
          const skinId = d.sunkShip.skinId || equippedSkin;
          drawShipOnGrid(myField, d.sunkShip.cells, d.sunkShip.orientation || 'H', skinId);
          previewSunkOnGrid(myField, d.sunkShip.cells, d.sunkShip.orientation || 'H', skinId);
        }
      }

      currentTurn = d.newTurn;
      turnLabel.innerText = String(currentTurn || '‚Äî');
      updateStatus(`–†–µ–∑—É–ª—å—Ç–∞—Ç: ${d.result} (${d.x},${d.y})`);
      if(d.finished){
        updateStatus('–ú–∞—Ç—á –∑–∞–≤–µ—Ä—à—ë–Ω. –ü–æ–±–µ–¥–∏—Ç–µ–ª—å: ' + (d.winner || '‚Äî'));
      }
    } catch(e){ console.error(e); logDbg(e); }
  });
  socket.on('purchase_result', data => {
    if(!data) return;
    if(data.ok){
      if(Array.isArray(data.ownedSkins)) ownedSkins = data.ownedSkins;
      else if(data.skinId && !ownedSkins.includes(data.skinId)) ownedSkins.push(data.skinId);
      localStorage.setItem('owned_skins', JSON.stringify(ownedSkins));
      equippedSkin = data.skinId || equippedSkin;
      localStorage.setItem('equipped_skin', equippedSkin);
      updateStatus('–ü–æ–∫—É–ø–∫–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ! –°–∫–∏–Ω –Ω–∞–¥–µ—Ç.');
      renderShopUI();
      renderAll();
    } else {
      updateStatus('–û—à–∏–±–∫–∞ –ø–æ–∫—É–ø–∫–∏: ' + (data.error || 'unknown'));
      if(data.error === 'not_enough_stars'){
        if(confirm('–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç stars. –û—Ç–∫—Ä—ã—Ç—å –º–∞–≥–∞–∑–∏–Ω?')) {
          if(WebApp && WebApp.openLink) WebApp.openLink(SHOP_URL); else window.open(SHOP_URL,'_blank');
        }
      }
    }
  });

  socket.on('match_finished', d=>{ updateStatus('–ú–∞—Ç—á –∑–∞–≤–µ—Ä—à—ë–Ω. –ü–æ–±–µ–¥–∏—Ç–µ–ª—å: ' + (d.winner || '‚Äî')); });
  socket.on('player_left', d=> updateStatus('–ò–≥—Ä–æ–∫ —É—à—ë–ª: ' + d.playerId) );
  socket.on('error', e=> logDbg('server error: ' + JSON.stringify(e)) );
}

/* helper: draw ship (ordered cells array) on given grid (enemy/my) using skin parts */
function drawShipOnGrid(gridEl, orderedCells, orientation, skinId){
  const skin = getSkinById(skinId);
  if(!skin) return;
  const size = orderedCells.length;
  orderedCells.forEach((coordOrIdx, i) => {
    let idx = (typeof coordOrIdx === 'number') ? coordOrIdx : cellIndex(coordOrIdx.x, coordOrIdx.y);
    const el = gridEl.children[idx];
    if(!el) return;
    el.innerHTML = '';
    let partName='body';
    if(size === 1) partName='single';
    else if(i===0) partName='head';
    else if(i===size-1) partName='tail';
    const url = skin.parts && skin.parts[partName];
    if(url){
      const img = document.createElement('img');
      img.className = 'part' + (orientation === 'V' ? ' rotated' : '');
      img.draggable = false;
      img.src = url;
      el.appendChild(img);
    } else {
      el.style.background = 'var(--occupied)';
    }
    el.classList.add('sunk');
  });
}

/* preview sunk with glow */
function previewSunkOnGrid(gridEl, orderedCells, orientation, skinId){
  orderedCells.forEach(coordOrIdx => {
    const idx = (typeof coordOrIdx === 'number') ? coordOrIdx : cellIndex(coordOrIdx.x, coordOrIdx.y);
    const el = gridEl.children[idx];
    if(!el) return;
    el.classList.add('sunk-preview','sunk-reveal');
  });
  setTimeout(()=> {
    orderedCells.forEach(coordOrIdx => {
      const idx = (typeof coordOrIdx === 'number') ? coordOrIdx : cellIndex(coordOrIdx.x, coordOrIdx.y);
      const el = gridEl.children[idx];
      if(!el) return;
      el.classList.remove('sunk-preview');
    });
  }, 1600);
}

/* ================== Buttons -> socket emits ================== */
createMatchBtn.addEventListener('click', ()=>{
  initSocket();
  socket.emit('create_match', { playerId: PLAYER_ID });
  updateStatus('–°–æ–∑–¥–∞–Ω–∏–µ –º–∞—Ç—á–∞...');
});

joinMatchBtn.addEventListener('click', ()=>{
  const id = matchIdInput.value.trim();
  if(!id){ updateStatus('–í–≤–µ–¥–∏—Ç–µ match id'); return; }
  initSocket();
  socket.emit('join_match', { matchId: id, playerId: PLAYER_ID });
  updateStatus('–ó–∞–ø—Ä–æ—à–µ–Ω–æ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ...');
});

findBtn.addEventListener('click', ()=>{
  initSocket();
  socket.emit('find_match', { playerId: PLAYER_ID });
  updateStatus('–í –ø–æ–∏—Å–∫–µ...');
});

leaveBtn.addEventListener('click', ()=>{
  if(!socket) initSocket();
  socket.emit('leave', { playerId: PLAYER_ID, matchId: currentMatchId });
  currentMatchId = null; matchLabel.innerText = '‚Äî';
  updateStatus('–í—ã—à–µ–ª –∏–∑ –º–∞—Ç—á–∞');
});

readyBtn.addEventListener('click', ()=>{
  if(!allPlaced()){ updateStatus('–°–Ω–∞—á–∞–ª–∞ —Ä–∞–∑–º–µ—Å—Ç–∏ –≤—Å–µ –∫–æ—Ä–∞–±–ª–∏'); return; }
  initSocket();
  socket.emit('place_ships', { matchId: currentMatchId, playerId: PLAYER_ID, ships: placed });
  updateStatus('–†–∞—Å—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞');
});

resignBtn.addEventListener('click', ()=>{
  if(!socket) initSocket();
  socket.emit('resign', { matchId: currentMatchId, playerId: PLAYER_ID });
  updateStatus('–í—ã —Å–¥–∞–ª–∏—Å—å');
});

/* ================== Shop UI: render, buy, equip ================== */
function renderShopUI(){
  shopCards.innerHTML = '';
  SKINS.forEach(skin=>{
    const item = document.createElement('div');
    item.style.display = 'flex';
    item.style.alignItems = 'center';
    item.style.gap = '8px';
    item.style.padding = '6px';
    item.style.border = '1px solid #eee';
    item.style.borderRadius = '8px';
    const preview = document.createElement('img');
    preview.src = skin.parts.head; preview.style.width='56px'; preview.style.height='36px'; preview.style.objectFit='cover'; preview.style.borderRadius='6px';
    item.appendChild(preview);
    const info = document.createElement('div'); info.style.flex='1';
    info.innerHTML = `<div style="font-weight:600">${skin.name}</div><div class="small">–¶–µ–Ω–∞: ${skin.price} stars</div>`;
    item.appendChild(info);
    const btn = document.createElement('button'); btn.className='ship-btn';
    const owned = ownedSkins.includes(skin.id);
    btn.innerText = owned ? (equippedSkin === skin.id ? '–ù–∞–¥–µ—Ç–æ' : '–ù–∞–¥–µ—Ç—å') : '–ö—É–ø–∏—Ç—å';
    btn.disabled = (owned && equippedSkin === skin.id);
    btn.onclick = () => {
      if(owned){
        equipSkinLocal(skin.id);
      } else {
        buySkinRequest(skin.id);
      }
    };
    item.appendChild(btn);
    shopCards.appendChild(item);
  });
}

function equipSkinLocal(skinId){
  if(!ownedSkins.includes(skinId)) return;
  equippedSkin = skinId;
  localStorage.setItem('equipped_skin', equippedSkin);
  if(socket && socket.connected) socket.emit('equip_skin', { playerId: PLAYER_ID, skinId });
  renderShopUI();
  renderAll();
}

function buySkinRequest(skinId){
  if(!socket) initSocket();
  if(socket && socket.connected){
    socket.emit('buy_skin', { playerId: PLAYER_ID, skinId });
    updateStatus('–ü–æ–∫—É–ø–∫–∞: –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä...');
    return;
  }
  updateStatus('–û—Ç–∫—Ä—ã–≤–∞—é –º–∞–≥–∞–∑–∏–Ω –≤ –±–æ—Ç–µ ‚Äî –∫—É–ø–∏ stars –∏ –≤–µ—Ä–Ω–∏—Å—å');
  if(WebApp && WebApp.openLink){ try{ WebApp.openLink(SHOP_URL); return; } catch(e){} }
  window.open(SHOP_URL, '_blank');
}

/* ================== Shop modal controls (inserted near end) ================== */
const shopModal = document.getElementById('shopModal');
const shopModalContent = document.getElementById('shopModalContent');
const shopClose = document.getElementById('shopClose');
const shopModalBuyAll = document.getElementById('shopModalBuyAll');

shopBtn.addEventListener('click', ()=> openShopModal());
shopClose.addEventListener('click', ()=> closeShopModal());
shopModalBuyAll.addEventListener('click', ()=> {
  if(WebApp && WebApp.openLink){ try{ WebApp.openLink(SHOP_URL); return; } catch(e){} }
  window.open(SHOP_URL, '_blank');
});

function openShopModal(){
  renderShopModalContent();
  shopModal.style.display = 'flex';
}
function closeShopModal(){
  shopModal.style.display = 'none';
}

function renderShopModalContent(){
  shopModalContent.innerHTML = '';
  SKINS.forEach(skin=>{
    const row = document.createElement('div');
    row.style.display='flex'; row.style.alignItems='center'; row.style.gap='8px'; row.style.padding='8px'; row.style.borderRadius='8px';
    const img = document.createElement('img'); img.src = skin.parts.head; img.style.width='72px'; img.style.height='44px'; img.style.objectFit='cover'; img.style.borderRadius='6px';
    row.appendChild(img);
    const info = document.createElement('div'); info.style.flex='1';
    info.innerHTML = `<div style="font-weight:700">${skin.name}</div><div class="small">–¶–µ–Ω–∞: ${skin.price} stars</div>`;
    row.appendChild(info);
    const btn = document.createElement('button'); btn.className='ship-btn';
    const owned = ownedSkins.includes(skin.id);
    btn.innerText = owned ? (equippedSkin===skin.id ? '–ù–∞–¥–µ—Ç–æ' : '–ù–∞–¥–µ—Ç—å') : '–ö—É–ø–∏—Ç—å';
    btn.onclick = ()=> {
      if(owned) equipSkinLocal(skin.id);
      else buySkinRequest(skin.id);
      renderShopModalContent();
    };
    row.appendChild(btn);
    shopModalContent.appendChild(row);
  });
}

/* ================== Init UI ================== */
function initUI(){
  buildFields();
  renderShipsPanel();
  renderAll();
  renderShopUI();
  modeLabel.innerText = 'railway';
  updateStatus('–ì–æ—Ç–æ–≤–æ ‚Äî –ø–æ–¥–∫–ª—é—á–∞—é—Å—å –∫ —Å–µ—Ä–≤–µ—Ä—É...');
  dbg.style.display = 'none';
  // auto connect socket (so UI is live)
  setTimeout(()=>{ try{ initSocket(); } catch(e){ console.warn(e); } }, 150);
}
initUI();

/* ================== load local shop state ================== */
(function loadLocalShop(){
  const lsOwned = localStorage.getItem('owned_skins');
  if(lsOwned) try{ ownedSkins = JSON.parse(lsOwned); } catch(e){}
  const eq = localStorage.getItem('equipped_skin');
  if(eq) equippedSkin = eq;
  renderShopUI();
  renderAll();
})();

/* ================== Notes: image size recommendation ==================
   - Use 64x64 px PNG/WebP for each part (head/body/tail/single).
   - Optionally add 128x128 for retina; browser scales down.
============================================================================= */

  </script>
</body>
  </html>
