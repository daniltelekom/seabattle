<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SeaStrike ‚Äî Placement v2 (Mobile)</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:sans-serif;padding:14px;background:#e3f2fd;color:#072146}
    h2{margin-bottom:8px}
    .row{display:flex;gap:8px;align-items:center;margin:8px 0}
    .btn{padding:10px 12px;border-radius:10px;border:0;background:#1976d2;color:#fff;font-weight:700;cursor:pointer}
    .btn.secondary{background:#90a4ae}
    .panel{background:#fff;padding:10px;border-radius:10px;box-shadow:0 4px 10px rgba(3,27,66,0.06)}
    .grid{display:grid;grid-template-columns:repeat(10,1fr);gap:4px;margin-top:12px}
    .cell{aspect-ratio:1;background:#e8f3ff;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:12px;color:#0b3d91;user-select:none}
    .cell.occupied{background:#90caf9}
    .cell.bad{background:#ffcdd2}
    .ships-panel{display:flex;flex-wrap:wrap;gap:8px}
    .ship-btn{padding:8px 10px;border-radius:8px;background:#2196f3;color:#fff;font-weight:700;cursor:pointer;min-width:44px;text-align:center}
    .ship-btn.selected{outline:3px solid #ffca28}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .rules{font-size:13px;color:#263238;margin-top:8px}
    #status{margin-top:8px;font-weight:700}
    @media (max-width:520px){
      body{padding:10px}
      .cell{font-size:11px}
      .ship-btn{min-width:34px;padding:6px}
    }
  </style>
</head>
<body>
  <h2>SeaStrike ‚Äî —Ä–∞—Å—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ—Ä–∞–±–ª–µ–π</h2>

  <div class="panel">
    <div class="row">
      <div style="flex:1">
        <div class="ships-panel" id="shipsPanel"></div>
        <div class="controls">
          <button class="btn secondary" id="rotateBtn">–ü–æ–≤–µ—Ä–Ω—É—Ç—å (H)</button>
          <button class="btn secondary" id="autoBtn">üîÄ –ê–≤—Ç–æ</button>
          <button class="btn secondary" id="undoBtn">‚Ü∂ –û—Ç–º–µ–Ω–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π</button>
          <button class="btn secondary" id="eraseModeBtn">üßΩ –†–µ–∂–∏–º —É–¥–∞–ª–µ–Ω–∏—è: –≤—ã–∫–ª</button>
        </div>
        <div class="rules" id="rules">
          <b>–ü—Ä–∞–≤–∏–ª–∞:</b> –°—Ç–∞–≤—å –∫–æ—Ä–∞–±–ª–∏ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ (H) –∏–ª–∏ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ (V). –ö–æ—Ä–∞–±–ª–∏ –Ω–µ –¥–æ–ª–∂–Ω—ã –ø–µ—Ä–µ–∫—Ä—ã–≤–∞—Ç—å—Å—è –∏ –Ω–µ –≤—ã—Ö–æ–¥—è—Ç –∑–∞ –ø–æ–ª–µ. –°–æ—Å–µ–¥—Å—Ç–≤–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ. –ù–∞–±–æ—Ä: 1√ó4, 2√ó3, 3√ó2, 4√ó1. –ù–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö: —Ç–∞–ø–Ω–∏ –Ω–∞ –∫–æ—Ä–∞–±–ª—å –≤ –ø–∞–Ω–µ–ª–∏ ‚Üí —Ç–∞–ø–Ω–∏ –ø–æ –∫–ª–µ—Ç–∫–µ –ø–æ–ª—è, —á—Ç–æ–±—ã –ø–æ—Å—Ç–∞–≤–∏—Ç—å. –ß—Ç–æ–±—ã —É–¥–∞–ª–∏—Ç—å ‚Äî –≤–∫–ª—é—á–∏ —Ä–µ–∂–∏–º —É–¥–∞–ª–µ–Ω–∏—è –∏ —Ç–∞–ø–Ω–∏ –ø–æ –∫–æ—Ä–∞–±–ª—é.
        </div>
      </div>
      <div style="width:220px;margin-left:12px">
        <div style="font-size:13px">–•–æ–¥ / —Å—Ç–∞—Ç—É—Å</div>
        <div id="status" class="panel">–ì–æ—Ç–æ–≤—å —Ä–∞—Å—Å—Ç–∞–Ω–æ–≤–∫—É</div>
      </div>
    </div>

    <div style="margin-top:12px" id="myFieldContainer">
      <div class="grid" id="myField"></div>
    </div>

    <div style="display:flex;gap:8px;margin-top:12px">
      <button class="btn" id="readyBtn" disabled>‚úÖ –ì–æ—Ç–æ–≤–æ</button>
      <button class="btn secondary" id="backBtn">‚¨Ö –ù–∞–∑–∞–¥</button>
    </div>
  </div>

  <script>
    // ---------------- Telegram init (fallback local test) ----------------
    const WebApp = window.Telegram?.WebApp || null;
    const initUser = WebApp?.initDataUnsafe?.user || { id: 12345, username: 'local_test' };
    const userId = initUser.id;
    if (WebApp) try { WebApp.expand?.(); } catch(e){ console.warn(e); }

    // ---------------- Data: ship set ----------------
    // –ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞–±–æ—Ä: 1x4, 2x3, 3x2, 4x1 (–≤—Å–µ–≥–æ 10 –∫–æ—Ä–∞–±–ª–µ–π, 20 –∫–ª–µ—Ç–æ–∫)
    const SHIP_SIZES = [4,3,3,2,2,2,1,1,1,1];
    // –î–ª—è —É–¥–æ–±—Å—Ç–≤–∞ –≥—Ä—É–ø–ø–∏—Ä—É–µ–º –≤ –æ–±—ä–µ–∫—Ç {size: count}
    function groupSizes(arr){
      const out = {};
      arr.forEach(s => out[s] = (out[s] || 0) + 1);
      return out;
    }
    let shipsPool = groupSizes(SHIP_SIZES); // remaining counts
    // Placed ships list: {id, size, startIdx, orientation: 'H'|'V', cells: []}
    let placed = [];
    let nextShipId = 1;

    // UI state
    let selectedSize = null; // —Ç–µ–∫—É—â–∏–π –≤—ã–±—Ä–∞–Ω–Ω—ã–π –∫–æ—Ä–∞–±–ª—å –¥–ª–∏–Ω—ã
    let orientation = 'H';
    let eraseMode = false;

    // Worker / mockFetch (–∫–∞–∫ —Ä–∞–Ω—å—à–µ)
    let worker = null;
    try { worker = new Worker('mock-worker.js'); } catch(e){ worker = null; console.warn('Worker not created, fallback used'); }
    function mockFetch(path, data = {}){
      if (worker) {
        return new Promise(resolve=>{
          const url = 'http://mock' + path;
          const onMsg = e => {
            if (e.data && e.data.url === url){ resolve(e.data.result); worker.removeEventListener('message', onMsg); }
            else if (e.data && e.data.error){ resolve(e.data); worker.removeEventListener('message', onMsg); }
          };
          worker.addEventListener('message', onMsg);
          worker.postMessage({ url: url, method: 'POST', body: data });
        });
      } else {
        const endpoints = {
          '/match/random/join': ()=>({ status:'matched', match_id:'demo-123', opponent_id:999999, is_your_turn:true }),
          '/match/demo-123/place-ships': ()=>({ status:'ok' }),
          '/match/demo-123/wait-ready': ()=>({ status:'ready' })
        };
        return new Promise(resolve => setTimeout(()=> resolve(endpoints[path] ? endpoints[path](data) : { error:'not found' }), 80));
      }
    }

    // ---------------- Build UI ----------------
    const myField = document.getElementById('myField');
    const shipsPanel = document.getElementById('shipsPanel');
    const rotateBtn = document.getElementById('rotateBtn');
    const autoBtn = document.getElementById('autoBtn');
    const undoBtn = document.getElementById('undoBtn');
    const eraseModeBtn = document.getElementById('eraseModeBtn');
    const readyBtn = document.getElementById('readyBtn');
    const statusEl = document.getElementById('status');

    function buildField(){
      myField.innerHTML = '';
      for (let i=0;i<100;i++){
        const c = document.createElement('div');
        c.className = 'cell';
        c.dataset.idx = i;
        // use click/tap for mobile; also support desktop click
        c.addEventListener('click', onCellClick);
        myField.appendChild(c);
      }
    }

    function renderShipsPanel(){
      shipsPanel.innerHTML = '';
      const grouped = groupSizes(SHIP_SIZES);
      // unique sizes sorted desc
      const unique = Array.from(new Set(SHIP_SIZES)).sort((a,b)=>b-a);
      unique.forEach(size=>{
        const countTotal = grouped[size];
        const countLeft = shipsPool[size] || 0;
        const btn = document.createElement('div');
        btn.className = 'ship-btn' + (selectedSize===size ? ' selected' : '');
        btn.innerText = `${size} √ó ${countLeft}`;
        btn.dataset.size = size;
        btn.addEventListener('click', ()=> {
          if (countLeft <= 0) return;
          // select this ship size (toggle)
          selectedSize = (selectedSize === size) ? null : size;
          renderShipsPanel();
          updateStatus();
        });
        shipsPanel.appendChild(btn);
      });
    }

    function cellCoords(idx){
      return { x: idx % 10, y: Math.floor(idx/10) };
    }

    function cellsForPlacement(startIdx, size, orient){
      const {x,y} = cellCoords(startIdx);
      const cells = [];
      if (orient === 'H'){
        for (let k=0;k<size;k++){
          const nx = x + k;
          if (nx > 9) return null;
          cells.push(y*10 + nx);
        }
      } else {
        for (let k=0;k<size;k++){
          const ny = y + k;
          if (ny > 9) return null;
          cells.push(ny*10 + x);
        }
      }
      return cells;
    }

    function overlaps(cells){
      const occupied = new Set(placed.flatMap(s => s.cells));
      return cells.some(c => occupied.has(c));
    }

    function placeShipAt(startIdx, size, orient){
      const cells = cellsForPlacement(startIdx, size, orient);
      if (!cells) return { ok:false, reason: 'out' };
      if (overlaps(cells)) return { ok:false, reason: 'overlap' };
      // place
      const ship = { id: nextShipId++, size, startIdx, orientation: orient, cells };
      placed.push(ship);
      shipsPool[size] = (shipsPool[size] || 0) - 1;
      renderAll();
      return { ok:true, ship };
    }

    function removeShipById(id){
      const idx = placed.findIndex(s=>s.id===id);
      if (idx === -1) return false;
      const s = placed[idx];
      shipsPool[s.size] = (shipsPool[s.size] || 0) + 1;
      placed.splice(idx,1);
      renderAll();
      return true;
    }

    function findShipByCell(idx){
      return placed.find(s => s.cells.includes(idx));
    }

    function renderAll(){
      // clear
      document.querySelectorAll('#myField .cell').forEach(c => {
        c.classList.remove('occupied','bad');
        c.textContent = '';
      });
      // draw placed ships
      placed.forEach(s => {
        s.cells.forEach((ci, i) => {
          const el = myField.children[ci];
          if (!el) return;
          el.classList.add('occupied');
          // label with size for first cell (small visual)
          if (i===0) el.textContent = s.size;
        });
      });
      // update ships panel & ready button
      renderShipsPanel();
      readyBtn.disabled = !allPlaced();
      updateStatus();
    }

    function allPlaced(){
      // all ships placed when pool counts are zero for every size
      return Object.values(shipsPool).every(v => v===0);
    }

    function updateStatus(msg){
      if (msg) { statusEl.textContent = msg; return; }
      if (allPlaced()) statusEl.textContent = '–í—Å–µ –∫–æ—Ä–∞–±–ª–∏ —Ä–∞—Å—Å—Ç–∞–≤–ª–µ–Ω—ã ‚Äî –Ω–∞–∂–º–∏ –ì–æ—Ç–æ–≤–æ';
      else if (selectedSize) statusEl.textContent = `–í—ã–±—Ä–∞–Ω–æ: –∫–æ—Ä–∞–±–ª—å –¥–ª–∏–Ω—ã ${selectedSize} (–æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è ${orientation})`;
      else statusEl.textContent = '–í—ã–±–µ—Ä–∏ –∫–æ—Ä–∞–±–ª—å –≤ –ø–∞–Ω–µ–ª–∏ –∏ —Ç–∞–ø–Ω–∏ –ø–æ –ø–æ–ª—é, —á—Ç–æ–±—ã –ø–æ—Å—Ç–∞–≤–∏—Ç—å';
    }

    // ---------------- Handlers ----------------
    function onCellClick(e){
      const idx = parseInt(e.currentTarget.dataset.idx);
      if (eraseMode){
        const ship = findShipByCell(idx);
        if (ship) {
          removeShipById(ship.id);
          updateStatus('–ö–æ—Ä–∞–±–ª—å —É–¥–∞–ª—ë–Ω');
        } else updateStatus('–ü–æ —ç—Ç–æ–π –∫–ª–µ—Ç–∫–µ –Ω–µ—Ç –∫–æ—Ä–∞–±–ª—è');
        return;
      }
      if (!selectedSize){
        updateStatus('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–æ—Ä–∞–±–ª—å –≤ –ø–∞–Ω–µ–ª–∏');
        return;
      }
      const res = placeShipAt(idx, selectedSize, orientation);
      if (!res.ok){
        if (res.reason === 'out') updateStatus('–ö–æ—Ä–∞–±–ª—å –Ω–µ –≤–ª–µ–∑–∞–µ—Ç –≤ —Å—Ç–æ—Ä–æ–Ω—É ' + orientation);
        else if (res.reason === 'overlap') updateStatus('–ù–∞–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ –¥—Ä—É–≥–æ–π –∫–æ—Ä–∞–±–ª—å ‚Äî –≤—ã–±–µ—Ä–∏ –¥—Ä—É–≥–æ–µ –º–µ—Å—Ç–æ');
      } else {
        updateStatus('–ö–æ—Ä–∞–±–ª—å –ø–æ—Å—Ç–∞–≤–ª–µ–Ω');
        // –µ—Å–ª–∏ –±–æ–ª—å—à–µ –Ω–µ—Ç —Ç–∞–∫–∏—Ö –∫–æ—Ä–∞–±–ª–µ–π ‚Äî —Å–±—Ä–æ—Å –≤—ã–±–æ—Ä–∞
        if ((shipsPool[selectedSize] || 0) <= 0) selectedSize = null;
      }
    }

    rotateBtn.addEventListener('click', ()=>{
      orientation = (orientation === 'H') ? 'V' : 'H';
      rotateBtn.innerText = `–ü–æ–≤–µ—Ä–Ω—É—Ç—å (${orientation})`;
      updateStatus();
    });

    autoBtn.addEventListener('click', ()=>{
      randomPlaceAll();
      updateStatus('–ê–≤—Ç–æ-—Ä–∞—Å—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞');
    });

    undoBtn.addEventListener('click', ()=>{
      if (placed.length===0) { updateStatus('–ù–µ—á–µ–≥–æ –æ—Ç–º–µ–Ω—è—Ç—å'); return; }
      const last = placed.pop();
      shipsPool[last.size] = (shipsPool[last.size] || 0) + 1;
      renderAll();
      updateStatus('–û—Ç–º–µ–Ω—ë–Ω –ø–æ—Å–ª–µ–¥–Ω–∏–π –∫–æ—Ä–∞–±–ª—å');
    });

    eraseModeBtn.addEventListener('click', ()=>{
      eraseMode = !eraseMode;
      eraseModeBtn.innerText = `üßΩ –†–µ–∂–∏–º —É–¥–∞–ª–µ–Ω–∏—è: ${eraseMode ? '–≤–∫–ª' : '–≤—ã–∫–ª'}`;
      eraseModeBtn.classList.toggle('selected', eraseMode);
      updateStatus();
    });

    readyBtn.addEventListener('click', async ()=>{
      if (!allPlaced()) { updateStatus('–°–Ω–∞—á–∞–ª–∞ —Ä–∞–∑–º–µ—Å—Ç–∏ –≤—Å–µ –∫–æ—Ä–∞–±–ª–∏'); return; }
      // –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ mock backend
      readyBtn.disabled = true;
      updateStatus('–û—Ç–ø—Ä–∞–≤–∫–∞ —Ä–∞—Å—Å—Ç–∞–Ω–æ–≤–∫–∏...');
      try{
        await mockFetch('/match/random/join', { telegram_id: userId });
        await mockFetch('/match/demo-123/place-ships', { telegram_id: userId, ships: placed });
        updateStatus('–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ. –û–∂–∏–¥–∞–µ–º –Ω–∞—á–∞–ª–∞ –º–∞—Ç—á–∞...');
        // –ø–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —ç–∫—Ä–∞–Ω ‚Äî –ø—Ä–æ—Å—Ç–æ–π —Å–∏–≥–Ω–∞–ª (–≤ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ –ø–æ–∫–∞–∂–∏ screen-match)
        setTimeout(async ()=>{
          await mockFetch('/match/demo-123/wait-ready', { telegram_id: userId });
          updateStatus('–ú–∞—Ç—á –Ω–∞—á–∞–ª—Å—è (–¥–µ–º–æ)');
          // —Ç—É—Ç –º–æ–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å initBattle() —Ç–≤–æ–µ–≥–æ –∏–≥—Ä–æ–≤–æ–≥–æ —ç–∫—Ä–∞–Ω–∞
        }, 600);
      } catch(err){
        console.error(err);
        updateStatus('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏');
      } finally { readyBtn.disabled = !allPlaced(); }
    });

    document.getElementById('backBtn').addEventListener('click', ()=> {
      // –ø—Ä–æ—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è (–≤ –æ—Ä–∏–≥–∏–Ω–∞–ª–µ ‚Äî –∫ –º–µ–Ω—é)
      updateStatus('–û—Ç–º–µ–Ω–∞ ‚Äî –Ω–∞–∑–∞–¥');
      // –í –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –Ω–∞–≤–∏–≥–∞—Ü–∏–∏, –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å showScreen('screen-menu')
    });

    // ---------------- Random placement util ----------------
    function clearAll(){
      placed = [];
      shipsPool = groupSizes(SHIP_SIZES);
      nextShipId = 1;
      selectedSize = null;
      orientation = 'H';
      eraseMode = false;
      eraseModeBtn.innerText = 'üßΩ –†–µ–∂–∏–º —É–¥–∞–ª–µ–Ω–∏—è: –≤—ã–∫–ª';
      renderAll();
    }

    function randomPlaceAll(){
      clearAll();
      const sizes = [...SHIP_SIZES]; // copy
      // shuffle sizes for some variance
      sizes.sort(()=>Math.random()-0.5);
      for (const s of sizes){
        let tries = 0;
        let placedOK = false;
        while(tries < 200 && !placedOK){
          const start = Math.floor(Math.random()*100);
          const orient = (Math.random() < 0.5) ? 'H' : 'V';
          const cells = cellsForPlacement(start, s, orient);
          if (cells && !overlaps(cells)){
            placed.push({ id: nextShipId++, size: s, startIdx: start, orientation: orient, cells });
            shipsPool[s] = (shipsPool[s] || 0) - 1;
            placedOK = true;
          }
          tries++;
        }
        if (!placedOK){
          // –µ—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å ‚Äî –¥–µ–ª–∞–µ–º –ø–æ–ª–Ω—É—é –ø–µ—Ä–µ–∑–∞–ø–∏—Å—å (—Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ)
          return randomPlaceAll();
        }
      }
      renderAll();
    }

    // ---------------- init ----------------
    function init(){
      buildField();
      renderShipsPanel();
      renderAll();
      updateStatus('–í—ã–±–µ—Ä–∏ –∫–æ—Ä–∞–±–ª—å –∏ —Ç–∞–ø–Ω–∏ –ø–æ –ø–æ–ª—é, —á—Ç–æ–±—ã –ø–æ—Å—Ç–∞–≤–∏—Ç—å. –ú–æ–∂–Ω–æ –Ω–∞–∂–∞—Ç—å "–ê–≤—Ç–æ" –¥–ª—è —Å–ª—É—á–∞–π–Ω–æ–π —Ä–∞—Å—Å—Ç–∞–Ω–æ–≤–∫–∏.');
    }

    init();
  </script>
</body>
</html>
