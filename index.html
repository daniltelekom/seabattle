<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>SeaStrike ‚Äî MiniApp</title>

  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --accent:#1976d2;
      --bg:#e9f4ff;
      --card:#fff;
      --cell:#d4e7ff;
      --miss:#eceff1;
      --hit:#f44336;
      --occupied:#2b9cff;
      --pending:#ffd54f;
      --sunk:#b71c1c;
      --ship-img-size:95%;
    }

    *{box-sizing:border-box;margin:0;padding:0}

    body{
      font-family:system-ui,Roboto,Arial;
      margin:10px;
      background:var(--bg);
      color:#072146;
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height:100vh;
    }

    .header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
    }

    .panel{
      background:var(--card);
      padding:10px;
      border-radius:12px;
      box-shadow:0 6px 18px rgba(2,20,60,0.06);
    }

    .layout{
      display:grid;
      grid-template-columns:1fr 320px;
      gap:12px;
    }
    @media (max-width:920px){
      .layout{grid-template-columns:1fr}
    }

    .field-wrap{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:8px;
    }

    .big-grid{width:100%;max-width:560px;display:grid;grid-template-columns:repeat(10,1fr);gap:0.3px}
    .small-grid{width:260px;display:grid;grid-template-columns:repeat(10,1fr);gap:0.3px}

    .cell{
      aspect-ratio:1;
      background:var(--cell);
      border-radius:4px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:12px;
      user-select:none;
      overflow:hidden;
      position:relative;
    }
    .cell.occupied{color:white}
    .cell.miss{background:var(--miss);color:#90a4ae}
    .cell.hit{background:var(--hit);color:white}
    .cell.pending{background:var(--pending)}
    .cell.sunk{background:var(--sunk);color:white}

    .cell img.part{
      width:100%;
      height:100%;
      object-fit:contain;
      pointer-events:none;
      user-select:none;
      display:block;
      margin:auto;
    }

    .cell.dot{position:relative}
    .cell.dot::after{
      content:'';
      position:absolute;
      width:32%;
      height:32%;
      border-radius:50%;
      background:#90a4ae;
    }
    .cell.explosion {
  background: none !important;
  position: relative;
}

.cell.explosion img.explosion-img {
  position: absolute;
  width: 90%;
  height: 90%;
  top: 5%;
  left: 5%;
  pointer-events: none;
}

    .rotated{
      transform-origin:center center;
      transform:rotate(90deg);
    }

    .ships-panel{display:flex;flex-wrap:wrap;gap:8px}

    .ship-btn{
      padding:8px 10px;
      border-radius:8px;
      background:#2196f3;
      color:#fff;
      border:none;
      min-width:42px;
    }
    .ship-btn.selected{outline:3px solid #ffca28}

    .footer{
      position:fixed;
      left:10px;
      right:10px;
      bottom:10px;
      display:flex;
      gap:8px;
      z-index:20;
    }
    .footer .panel{
      flex:1;
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:10px;
    }

    .info{font-size:13px;color:#263238}
    .small{font-size:12px;color:#3b4752}

    #dbg{
      position:fixed;
      right:8px;
      top:8px;
      background:rgba(0,0,0,0.75);
      color:#fff;
      padding:6px 8px;
      border-radius:6px;
      display:none;
      max-width:46%;
      white-space:pre-wrap;
      z-index:60;
      font-size:12px;
    }

    .shop-btn{
      background:linear-gradient(90deg,#ffb74d,#ff8a65);
      border:none;
      color:#fff;
      padding:8px 10px;
      border-radius:8px;
    }

    input, select{padding:8px;border-radius:8px;border:1px solid #ddd}
    .compact{font-size:12px}
    .label-muted{font-size:12px;color:#607d8b}
    .enemy-title{font-weight:700;margin-bottom:6px}

    .sunk-preview{
      box-shadow:0 0 0 3px rgba(255,215,0,0.9),0 8px 30px rgba(0,0,0,0.15);
      transform:scale(1.06);
      transition:transform .28s ease, box-shadow .28s ease;
      border-radius:6px;
    }
    @keyframes reveal-sunk{
      0%{opacity:0;transform:scale(0.9);}
      60%{opacity:1;transform:scale(1.04);}
      100%{opacity:1;transform:scale(1);}
    }
    .sunk-reveal{animation:reveal-sunk .34s cubic-bezier(.2,.9,.3,1);}

    /* –±–∞–Ω–Ω–µ—Ä —á–µ–π —Ö–æ–¥ */
    .turn-banner{
      margin-top:8px;
      margin-bottom:4px;
      font-size:14px;
      font-weight:600;
      padding:4px 12px;
      border-radius:999px;
      background:#e0f2ff;
      color:#072146;
    }
    .turn-banner.my-turn{
      background:#c8e6c9;
      color:#1b5e20;
    }
    .turn-banner.enemy-turn{
      background:#ffe0b2;
      color:#e65100;
    }

    .turn-row{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:8px;
  margin-top:6px;
  margin-bottom:4px;
}

.player-info{
  min-width:80px;
  text-align:center;
  font-size:11px;
}

.player-info .rank-title{
  font-weight:600;
}

.player-info .rank-mmr{
  font-size:11px;
  color:#455a64;
}

/* –í–µ—Ä—Ö–Ω—è—è –º–∏–Ω–∏-–ø–ª–∞—à–∫–∞ —Å —Ç–≤–æ–∏–º –∑–≤–∞–Ω–∏–µ–º */
#playerRankPanel{
  margin-top:4px;
  margin-bottom:4px;
  font-size:13px;
  padding:6px 10px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

    /* –ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ (–æ–≤–µ—Ä–ª–µ–π –ø–æ —Ü–µ–Ω—Ç—Ä—É) */
    #mainMenu{
      position:fixed;
      left:0;
      top:0;
      right:0;
      bottom:0;
      display:flex;
      align-items:center;
      justify-content:center;
      background:radial-gradient(circle at top,#ffffffee 0,#e3f2fdcc 45%,#bbdefbcc 100%);
      z-index:1500;
    }
    #mainMenu .menu-card{
      width:92%;
      max-width:360px;
      background:#fff;
      border-radius:20px;
      padding:20px 18px 16px;
      box-shadow:0 14px 40px rgba(2,20,60,0.25);
      text-align:center;
    }
    #mainMenu .game-title{
      font-size:22px;
      font-weight:800;
      margin-bottom:4px;
      letter-spacing:0.03em;
    }
    #mainMenu .game-sub{
      font-size:13px;
      color:#607d8b;
      margin-bottom:16px;
    }
    #mainMenu .menu-btn{
      width:100%;
      padding:12px 10px;
      border-radius:999px;
      border:none;
      font-size:16px;
      font-weight:600;
      margin-bottom:10px;
      color:#fff;
      background:linear-gradient(90deg,#1976d2,#42a5f5);
    }
    #mainMenu .menu-btn.secondary{
      background:#fff;
      color:#1976d2;
      border:2px solid #1976d2;
    }
    #mainMenu .menu-btn.shop{
      background:linear-gradient(90deg,#ffb74d,#ff8a65);
    }

    /* –û–≤–µ—Ä–ª–µ–π –ø–æ–∏—Å–∫–∞ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞ */
    #searchOverlay{
      position:fixed;
      left:0;top:0;right:0;bottom:0;
      display:none;
      align-items:center;
      justify-content:center;
      background:rgba(0,0,0,0.35);
      z-index:1600;
    }
    #searchOverlay .search-card{
      background:#fff;
      border-radius:16px;
      padding:14px 16px;
      width:80%;
      max-width:260px;
      text-align:center;
      box-shadow:0 10px 30px rgba(0,0,0,0.3);
      font-size:14px;
    }
    .spinner{
      width:18px;
      height:18px;
      border-radius:50%;
      border:3px solid #bbdefb;
      border-top-color:#1976d2;
      animation:spin 0.8s linear infinite;
      margin:0 auto 8px;
    }
    @keyframes spin{
      to{transform:rotate(360deg);}
    }

    /* –ú–æ–¥–∞–ª–∫–∞ –∫–æ–Ω—Ü–∞ –º–∞—Ç—á–∞ */
    #endModal{
      display:none;
      position:fixed;
      left:0;top:0;right:0;bottom:0;
      align-items:center;
      justify-content:center;
      background:rgba(0,0,0,0.45);
      z-index:2000;
    }
  </style>
</head>
<body>
  <div class="header">
    <div>
      <h2>SeaStrike ‚Äî MiniApp</h2>
      <div class="small">–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –º–æ—Ä—Å–∫–æ–π –±–æ–π ‚Äî –∫–ª–∏–∫–∞–π –ø–æ –ø–æ–ª—é –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞, —á—Ç–æ–±—ã —Å—Ç—Ä–µ–ª—è—Ç—å.</div>
    </div>
    <div class="small">PlayerID: <span id="playerIdLabel">‚Äî</span></div>
  </div>

  <!-- –ü–ª–∞—à–∫–∞ —Å–æ –∑–≤–∞–Ω–∏–µ–º/—Ä–µ–π—Ç–∏–Ω–≥–æ–º (–¥–ª—è —Ç–µ–±—è) -->
  <div class="panel" id="playerRankPanel">
    <div>
      <span id="topRank">–ù–æ–≤–æ–±—Ä–∞–Ω–µ—Ü</span>
      <span style="opacity:.7;">¬∑</span>
      <span id="topRating">1000</span> MMR
    </div>
    <div class="small" id="topGamesInfo">
      –õ–æ–∫–∞–ª—å–Ω—ã–π —Ä–µ–π—Ç–∏–Ω–≥
    </div>
  </div>
  
  <!-- –û—Å–Ω–æ–≤–Ω–æ–π –ª–µ–π–∞—É—Ç -->
  <div class="layout">
    <!-- –õ–µ–≤–æ: –ø–æ–ª—è -->
    <div>
  <div class="enemy-title">–ü–æ–ª–µ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞ (–∫–ª–∏–∫ ‚Äî —Å—Ç—Ä–µ–ª—è—Ç—å)</div>
  <div id="enemyField" class="big-grid" aria-label="–ü–æ–ª–µ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞"></div>
</div>

<!-- –ù–æ–≤—ã–π –±–ª–æ–∫: —Å–ª–µ–≤–∞ —Ç—ã, —Å–ø—Ä–∞–≤–∞ —Å–æ–ø–µ—Ä–Ω–∏–∫, –≤ —Ü–µ–Ω—Ç—Ä–µ —á–µ–π —Ö–æ–¥ -->
<div class="turn-row">
  <div class="player-info">
    <div id="myRankLabel" class="rank-title">–ù–æ–≤–æ–±—Ä–∞–Ω–µ—Ü</div>
    <div class="rank-mmr">
      <span id="myRatingLabel">1000</span> MMR
    </div>
  </div>

  <div id="turnBanner" class="turn-banner">
    –ñ–¥—ë–º –Ω–∞—á–∞–ª–∞ –º–∞—Ç—á–∞...
  </div>

  <div class="player-info">
    <div id="enemyRankLabel" class="rank-title">–°–æ–ø–µ—Ä–Ω–∏–∫</div>
    <div class="rank-mmr">
      <span id="enemyRatingLabel">?</span>
    </div>
  </div>
</div>

<div style="margin-top:12px">
  <div class="label-muted">–í–∞—à–µ –ø–æ–ª–µ</div>
  <div id="myField" class="small-grid" aria-label="–í–∞—à–µ –ø–æ–ª–µ"></div>
</div>

      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px">
        <div class="ships-panel" id="shipsPanel"></div>
        <div style="display:flex;gap:8px">
          <button id="rotateBtn" class="ship-btn">–ü–æ–≤–µ—Ä–Ω—É—Ç—å (H)</button>
          <button id="autoBtn" class="ship-btn">–ê–≤—Ç–æ</button>
        </div>
      </div>

      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px">
        <div id="status" class="small">–†–∞—Å—Å—Ç–∞–≤—å—Ç–µ –∫–æ—Ä–∞–±–ª–∏ –∏ –Ω–∞–∂–º–∏—Ç–µ –ì–æ—Ç–æ–≤.</div>
        <div style="display:flex;gap:8px">
          <button id="undoBtn" class="ship-btn">‚Ü∂ –û—Ç–º–µ–Ω–∏—Ç—å</button>
          <button id="eraseModeBtn" class="ship-btn">–£–¥–∞–ª–µ–Ω–∏–µ: –≤—ã–∫–ª</button>
        </div>
      </div>
    </div>

    <!-- –ü—Ä–∞–≤–æ: –∏–Ω—Ñ–æ/–º–∞—Ç—á -->
    <div>
      <div id="sidePanel" class="panel" style="display:flex;flex-direction:column;gap:10px">

        <!-- –í—Å—ë —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–∞—Ç—á–∞–º–∏ (—É–±–∏—Ä–∞–µ–º –≤–æ –≤—Ä–µ–º—è –º–∞—Ç—á–∞) -->
        <div id="sideControls">
          <div class="label-muted">–ë—ã—Å—Ç—Ä—ã–π –º–∞—Ç—á</div>
          <button id="quickPlayBtn" class="ship-btn" style="width:100%;font-size:15px;padding:10px 10px;">
            ‚ñ∂ –ù–∞–π—Ç–∏ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞
          </button>

          <div class="label-muted" style="margin-top:4px;">–ò–≥—Ä–∞ —Å –¥—Ä—É–≥–æ–º</div>
          <div style="display:flex;gap:8px;align-items:center">
            <button id="createMatchBtn" class="ship-btn">–°–æ–∑–¥–∞—Ç—å</button>
            <input id="matchIdInput" placeholder="match id" style="flex:1"/>
            <button id="joinMatchBtn" class="ship-btn">–í–æ–π—Ç–∏</button>
          </div>

          <div style="display:flex;gap:8px">
            <button id="leaveBtn" class="ship-btn" style="flex:1">–í—ã–π—Ç–∏ –∏–∑ –º–∞—Ç—á–∞</button>
            <button id="shopBtn" class="shop-btn" style="flex:1">–ú–∞–≥–∞–∑–∏–Ω</button>
          </div>
        </div>

        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–∞—Ç—á–µ (–æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ Match:) -->
        <div id="sideInfo" class="compact" style="display:flex;flex-direction:column;gap:6px;">
          <div id="infoModeRow" class="info">Mode: <span id="modeLabel">railway</span></div>
          <div id="infoMatchRow" class="info">Match: <span id="matchLabel">‚Äî</span></div>
          <div id="infoTurnRow" class="info">Turn: <span id="turnLabel">‚Äî</span></div>
          <div id="infoRatingRow" class="info">Rating: <span id="ratingLabel">1000</span></div>
        </div>

      </div>
    </div>

  <div id="dbg">DBG</div>

  <!-- –§—É—Ç–µ—Ä -->
  <div class="footer">
    <div class="panel">
      <div class="info">–ü–æ–¥–¥–µ—Ä–∂–∫–∞: Railway (online socket)</div>
      <div style="display:flex;gap:8px">
        <button id="readyBtn" class="ship-btn">‚úÖ –ì–æ—Ç–æ–≤</button>
        <button id="resignBtn" class="ship-btn">–°–¥–∞—Ç—å—Å—è</button>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ –º–∞–≥–∞–∑–∏–Ω–∞ -->
  <div id="shopModal" style="display:none;position:fixed;left:0;top:0;right:0;bottom:0;align-items:center;justify-content:center;background:rgba(0,0,0,0.5);z-index:5000;">
    <div style="width:92%;max-width:420px;background:white;border-radius:14px;padding:14px;position:relative;text-align:center;box-shadow:0 10px 30px rgba(0,0,0,0.2);">
      <button id="shopClose" style="position:absolute;right:10px;top:10px;background:transparent;border:none;font-size:18px;cursor:pointer;">‚úï</button>
      <div style="font-size:18px;font-weight:700;margin-bottom:8px;">üéÅ –ú–∞–≥–∞–∑–∏–Ω —Å–∫–∏–Ω–æ–≤</div>
      <div id="shopModalContent" style="display:flex;flex-direction:column;gap:8px;max-height:60vh;overflow:auto;padding:6px;"></div>
      <div style="margin-top:10px;">
        <button id="shopModalBuyAll" class="ship-btn" style="background:linear-gradient(90deg,#4caf50,#388e3c);">–ö—É–ø–∏—Ç—å/–û—Ç–∫—Ä—ã—Ç—å –≤ –±–æ—Ç–µ</button>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ –∫–æ–Ω—Ü–∞ –º–∞—Ç—á–∞ -->
  <div id="endModal">
    <div style="background:#fff;border-radius:12px;padding:16px 14px;
                max-width:320px;width:90%;box-shadow:0 10px 30px rgba(0,0,0,0.3);
                text-align:center;">
      <div id="endModalTitle"
           style="font-weight:700;font-size:18px;margin-bottom:6px;">
        –ú–∞—Ç—á –∑–∞–≤–µ—Ä—à—ë–Ω
      </div>
      <div id="endModalText"
           class="small"
           style="margin-bottom:12px;">
        –ü–æ–±–µ–¥–∏—Ç–µ–ª—å: ‚Äî
      </div>
      <div style="display:flex;gap:8px;justify-content:center;">
        <button id="endRematchBtn" class="ship-btn" style="flex:1;">–†–µ–≤–∞–Ω—à</button>
        <button id="endExitBtn" class="ship-btn"
                style="flex:1;background:#e53935;">–í—ã–π—Ç–∏</button>
      </div>
    </div>
  </div>

  <!-- –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é (–æ–≤–µ—Ä–ª–µ–π) -->
  <div id="mainMenu">
    <div class="menu-card">
      <div class="game-title">SeaStrike</div>
      <div class="game-sub">–ú–æ—Ä—Å–∫–æ–π –±–æ–π 1√ó1 ‚Äî –∏–≥—Ä–∞–π —Å –¥—Ä—É–≥–æ–º –∏–ª–∏ —Å —Ä–∞–Ω–¥–æ–º–æ–º</div>

      <button id="menuPlayQuick" class="menu-btn">
        ‚ñ∂ –ò–≥—Ä–∞—Ç—å (–±—ã—Å—Ç—Ä—ã–π –º–∞—Ç—á)
      </button>

      <button id="menuPlayFriend" class="menu-btn secondary">
        üë• –ò–≥—Ä–∞ —Å –¥—Ä—É–≥–æ–º
      </button>

      <button id="menuShop" class="menu-btn shop">
        üõí –ú–∞–≥–∞–∑–∏–Ω —Å–∫–∏–Ω–æ–≤
      </button>

      <div class="small" style="margin-top:8px;color:#90a4ae;">
        –°–æ–≤–º–µ—Å—Ç–∏–º–æ —Å Telegram MiniApp ‚Ä¢ rating: 1000
      </div>
    </div>
  </div>

  <!-- –û–≤–µ—Ä–ª–µ–π –ø–æ–∏—Å–∫–∞ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞ -->
  <div id="searchOverlay">
    <div class="search-card">
      <div class="spinner"></div>
      <div style="font-weight:600;margin-bottom:4px;">–ü–æ–∏—Å–∫ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞‚Ä¶</div>
      <div class="small">–ñ–¥—ë–º –≤—Ç–æ—Ä–æ–≥–æ –∏–≥—Ä–æ–∫–∞</div>
    </div>
  </div>

<script>
/* ====== –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ====== */
const SOCKET_URL = "https://seabattle-server-production.up.railway.app";
const SHOP_URL   = "https://t.me/YourBotOrShop";

/* ====== –°–∫–∏–Ω—ã ====== */
const SKINS = [
  { id:'blue', name:'Blue Steel', price:50, parts:{
    head:'assets/skins/blue_head.png',
    body:'assets/skins/blue_body.png',
    tail:'assets/skins/blue_tail.png',
    single:'assets/skins/blue_single.png'
  }},
  { id:'red', name:'Crimson', price:75, parts:{
    head:'assets/skins/red_head.png',
    body:'assets/skins/red_body.png',
    tail:'assets/skins/red_tail.png',
    single:'assets/skins/red_single.png'
  }},
  { id:'gold', name:'Gold', price:150, parts:{
    head:'assets/skins/gold_head.png',
    body:'assets/skins/gold_body.png',
    tail:'assets/skins/gold_tail.png',
    single:'assets/skins/gold_single.png'
  }}
];

/* ====== –ò–≥—Ä–æ–∫ ====== */
const WebApp   = window.Telegram?.WebApp || null;
const initUser = WebApp?.initDataUnsafe?.user || { id: Math.floor(Math.random()*1e6), username:'local_test' };
const PLAYER_ID   = String(initUser.id);
const PLAYER_NAME = initUser.username || ('p' + PLAYER_ID);
document.getElementById('playerIdLabel').innerText = PLAYER_ID;

/* ====== UI —Å—Å—ã–ª–∫–∏ ====== */
const enemyField   = document.getElementById('enemyField');
const myField      = document.getElementById('myField');
const shipsPanel   = document.getElementById('shipsPanel');
const rotateBtn    = document.getElementById('rotateBtn');
const autoBtn      = document.getElementById('autoBtn');
const undoBtn      = document.getElementById('undoBtn');
const eraseModeBtn = document.getElementById('eraseModeBtn');
const readyBtn     = document.getElementById('readyBtn');
const resignBtn    = document.getElementById('resignBtn');
const statusEl     = document.getElementById('status');

const quickPlayBtn   = document.getElementById('quickPlayBtn');
const createMatchBtn = document.getElementById('createMatchBtn');
const joinMatchBtn   = document.getElementById('joinMatchBtn');
const leaveBtn       = document.getElementById('leaveBtn');
const matchIdInput   = document.getElementById('matchIdInput');
const matchLabel     = document.getElementById('matchLabel');
const turnLabel      = document.getElementById('turnLabel');
const modeLabel      = document.getElementById('modeLabel');
const shopBtn        = document.getElementById('shopBtn');
const dbg            = document.getElementById('dbg');
const turnBanner     = document.getElementById('turnBanner');
const ratingLabel      = document.getElementById('ratingLabel');  

/* –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é + –ø–æ–∏—Å–∫ */
const mainMenu      = document.getElementById('mainMenu');
const menuPlayQuick = document.getElementById('menuPlayQuick');
const menuPlayFriend= document.getElementById('menuPlayFriend');
const menuShop      = document.getElementById('menuShop');
const searchOverlay = document.getElementById('searchOverlay');

/* –ú–∞–≥–∞–∑–∏–Ω */
const shopModal        = document.getElementById('shopModal');
const shopModalContent = document.getElementById('shopModalContent');
const shopClose        = document.getElementById('shopClose');
const shopModalBuyAll  = document.getElementById('shopModalBuyAll');

/* –ú–æ–¥–∞–ª–∫–∞ –∫–æ–Ω—Ü–∞ –º–∞—Ç—á–∞ */
const endModal       = document.getElementById('endModal');
const endModalText   = document.getElementById('endModalText');
const endRematchBtn  = document.getElementById('endRematchBtn');
const endExitBtn     = document.getElementById('endExitBtn');

  /* –ó–≤–∞–Ω–∏—è / —Ä–µ–π—Ç–∏–Ω–≥ –≤ UI */
const topRankEl        = document.getElementById('topRank');
const topRatingEl      = document.getElementById('topRating');
const topGamesInfoEl   = document.getElementById('topGamesInfo');

const myRankLabel      = document.getElementById('myRankLabel');
const myRatingLabel    = document.getElementById('myRatingLabel');
const enemyRankLabel   = document.getElementById('enemyRankLabel');
const enemyRatingLabel = document.getElementById('enemyRatingLabel');

/* ====== –°–æ—Å—Ç–æ—è–Ω–∏–µ ====== */
let socket         = null;
let currentMatchId = null;
let currentTurn    = null;
let matchFinished  = false;

  // –†–µ–π—Ç–∏–Ω–≥ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (–ª–æ–∫–∞–ª—å–Ω–æ –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ)
let playerRating = parseInt(localStorage.getItem('rating') || '1000', 10);
let totalWins    = parseInt(localStorage.getItem('wins')   || '0',    10);
let totalLosses  = parseInt(localStorage.getItem('losses') || '0',    10);

// –ó–≤–∞–Ω–∏—è –ø–æ —Ä–µ–π—Ç–∏–Ω–≥—É
function getRankName(r) {
  if (r < 900)  return '–ù–æ–≤–æ–±—Ä–∞–Ω–µ—Ü';
  if (r < 1000) return '–ú–∞—Ç—Ä–æ—Å';
  if (r < 1100) return '–ö–∞–ø—Ä–∞–ª';
  if (r < 1200) return '–°—Ç–∞—Ä—à–∏–Ω–∞';
  if (r < 1300) return '–õ–µ–π—Ç–µ–Ω–∞–Ω—Ç';
  if (r < 1400) return '–ö–∞–ø–∏—Ç–∞–Ω';
  if (r < 1500) return '–ö–æ–º–º–æ–¥–æ—Ä';
  return '–ê–¥–º–∏—Ä–∞–ª';
}

// –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞–¥–ø–∏—Å—å –≤ –ø—Ä–∞–≤–æ–π –ø–∞–Ω–µ–ª–∏
function updateRatingUI() {
  if (!ratingLabel) return;
  const rank = getRankName(playerRating);
  ratingLabel.textContent = `${playerRating} (${rank})`;
}

// –°—Ä–∞–∑—É –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
updateRatingUI();

/* –†–∞—Å—Å—Ç–∞–Ω–æ–≤–∫–∞ */
const SHIP_SIZES = [4,3,3,2,2,2,1,1,1,1];
function group(arr){ const out={}; arr.forEach(s=>out[s]=(out[s]||0)+1); return out; }
let shipsPool    = group(SHIP_SIZES);
let placed       = [];
let nextShipId   = 1;
let selectedSize = null;
let orientation  = 'H';
let eraseMode    = false;

/* –°–∫–∏–Ω—ã –ª–æ–∫–∞–ª—å–Ω–æ */
let ownedSkins   = JSON.parse(localStorage.getItem('owned_skins') || '["blue"]');
let equippedSkin = localStorage.getItem('equipped_skin') || 'blue';

  /* ====== –†–µ–π—Ç–∏–Ω–≥ / –∑–≤–∞–Ω–∏—è (–ª–æ–∫–∞–ª—å–Ω–æ) ====== */
// –†–ï–ô–¢–ò–ù–ì–ò
let myRating = 1000;      // –ø—Ä–∏–¥—ë—Ç —Å —Å–µ—Ä–≤–µ—Ä–∞ —á–µ—Ä–µ–∑ rating_info
let enemyRating = null;   // —É–∑–Ω–∞–µ–º, –∫–æ–≥–¥–∞ –Ω–∞–π–¥—ë–º –º–∞—Ç—á

let myRankTitle = '–ù–æ–≤–æ–±—Ä–∞–Ω–µ—Ü';
let enemyRankTitle = '–°–æ–ø–µ—Ä–Ω–∏–∫';

// –ø–æ–ª—É—á–∞–µ–º –¥–æ–º-—ç–ª–µ–º–µ–Ω—Ç—ã –ø–∞–Ω–µ–ª–∏ (—É —Ç–µ–±—è –æ–Ω–∏ —É–∂–µ –µ—Å—Ç—å –≤ HTML)
const myRankLabel      = document.getElementById('myRankLabel');
const myRatingLabel    = document.getElementById('myRatingLabel');
const enemyRankLabel   = document.getElementById('enemyRankLabel');
const enemyRatingLabel = document.getElementById('enemyRatingLabel');

// –ø—Ä–æ—Å—Ç–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–≤–∞–Ω–∏—è –ø–æ MMR
function rankByRating(r) {
  if (r >= 1400) return '–ê–¥–º–∏—Ä–∞–ª';
  if (r >= 1200) return '–ö–∞–ø–∏—Ç–∞–Ω';
  if (r >= 1000) return '–ù–æ–≤–æ–±—Ä–∞–Ω–µ—Ü';
  return '–†–µ–∫—Ä—É—Ç';
}

function recalcRanks() {
  myRankTitle = rankByRating(myRating);
  enemyRankTitle = enemyRating != null
    ? rankByRating(enemyRating)
    : '–°–æ–ø–µ—Ä–Ω–∏–∫';
}

// –æ–±–Ω–æ–≤–ª—è–µ–º –Ω–∞–¥–ø–∏—Å–∏ —Å–ª–µ–≤–∞/—Å–ø—Ä–∞–≤–∞ –æ—Ç –±–∞–Ω–Ω–µ—Ä–∞ —Ö–æ–¥–∞
function updateSidePanelState() {
  if (myRankLabel)   myRankLabel.textContent = myRankTitle;
  if (myRatingLabel) myRatingLabel.textContent = myRating + ' MMR';

  if (enemyRankLabel)   enemyRankLabel.textContent = enemyRankTitle;
  if (enemyRatingLabel) {
    enemyRatingLabel.textContent =
      enemyRating != null ? (enemyRating + ' MMR') : '?';
  }
}

// –º–∞–ø–ø–∏–Ω–≥ —Ä–µ–π—Ç–∏–Ω–≥–∞ -> –∑–≤–∞–Ω–∏–µ
function titleForRating(r) {
  if (r >= 1500) return '–ê–¥–º–∏—Ä–∞–ª';
  if (r >= 1350) return '–ö–∞–ø–∏—Ç–∞–Ω';
  if (r >= 1200) return '–õ–µ–π—Ç–µ–Ω–∞–Ω—Ç';
  if (r >= 1100) return '–ú–∞—Ç—Ä–æ—Å';
  return '–ù–æ–≤–æ–±—Ä–∞–Ω–µ—Ü';
}

// –æ–±–Ω–æ–≤–ª—è–µ–º –≤–µ—Å—å UI, —Å–≤—è–∑–∞–Ω–Ω—ã–π —Å —Ä–µ–π—Ç–∏–Ω–≥–æ–º
function updateRanksUI() {
  const rankName = titleForRating(myRating);

  if (topRankEl)    topRankEl.textContent    = rankName;
  if (topRatingEl)  topRatingEl.textContent  = myRating;

  if (myRankLabel)  myRankLabel.textContent  = rankName;
  if (myRatingLabel) myRatingLabel.textContent = myRating;

  if (topGamesInfoEl) {
    topGamesInfoEl.textContent =
      gamesPlayed > 0
        ? `–ú–∞—Ç—á–µ–π —Å—ã–≥—Ä–∞–Ω–æ: ${gamesPlayed}`
        : '–õ–æ–∫–∞–ª—å–Ω—ã–π —Ä–µ–π—Ç–∏–Ω–≥';
  }

  // —Å–ø—Ä–∞–≤–∞ –ø–æ–∫–∞ —Ä–µ–π—Ç–∏–Ω–≥–∞ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞ –Ω–µ—Ç ‚Äî –ø—Ä–æ—Å—Ç–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º ?
  if (enemyRankLabel)   enemyRankLabel.textContent   = '–°–æ–ø–µ—Ä–Ω–∏–∫';
  if (enemyRatingLabel) enemyRatingLabel.textContent = enemyRating != null ? enemyRating : '?';
}

/* ====== helpers ====== */
function logDbg(msg){
  if(!dbg) return;
  dbg.style.display='block';
  try{ dbg.innerText = typeof msg === 'string' ? msg : JSON.stringify(msg,null,2); }
  catch(e){ dbg.innerText = String(msg); }
}
function coords(idx){ return { x:idx%10, y:Math.floor(idx/10) }; }
function cellIndex(x,y){ return y*10 + x; }
function cellsFor(start,size,orient){
  const p = coords(start); const cells=[];
  if(orient==='H'){ for(let k=0;k<size;k++){ const nx=p.x+k; if(nx>9) return null; cells.push(cellIndex(nx,p.y)); } }
  else{ for(let k=0;k<size;k++){ const ny=p.y+k; if(ny>9) return null; cells.push(cellIndex(p.x,ny)); } }
  return cells;
}
function adjacentCellsOf(c){
  const {x,y}=coords(c); const out=[];
  for(let dy=-1;dy<=1;dy++) for(let dx=-1;dx<=1;dx++){
    const nx=x+dx,ny=y+dy;
    if(nx>=0&&nx<10&&ny>=0&&ny<10) out.push(cellIndex(nx,ny));
  }
  return out;
}
function overlapsOrAdjacent(cells){
  const occ=new Set(placed.flatMap(s=>s.cells));
  for(const c of cells){
    if(occ.has(c)) return {overlap:true};
    for(const n of adjacentCellsOf(c)) if(occ.has(n)) return {adjacent:true,at:n};
  }
  return null;
}
  function updateSidePanelState() {
  const sideControls = document.getElementById('sideControls');
  const modeRow      = document.getElementById('infoModeRow');
  const turnRow      = document.getElementById('infoTurnRow');
  const ratingRow    = document.getElementById('infoRatingRow');

  const hasMatch = !!currentMatchId;  // –µ—Å—Ç—å –∫–∞–∫–æ–π-—Ç–æ –º–∞—Ç—á (–∏–≥—Ä–∞/—Ä–∞—Å—Å—Ç–∞–Ω–æ–≤–∫–∞)

  if (sideControls) {
    // –≤–æ –≤—Ä–µ–º—è –º–∞—Ç—á–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∫—Ä—ã–≤–∞–µ–º
    sideControls.style.display = hasMatch ? 'none' : 'flex';
    if (!hasMatch) {
      sideControls.style.flexDirection = 'column';
      sideControls.style.gap = '10px';
    }
  }

    function applyEnemyRatingFromMatchPayload(d) {
  if (!d || !Array.isArray(d.players)) return;

  const me = String(PLAYER_ID);
  const oppId = d.players.find(p => String(p) !== me);
  if (!oppId) return;

  if (d.ratings && typeof d.ratings[oppId] === 'number') {
    enemyRating = d.ratings[oppId];
    recalcRanks();
    updateSidePanelState();
  }
}

  // –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫—É Match:, –≤—Å—ë –æ—Å—Ç–∞–ª—å–Ω–æ–µ –ø—Ä—è—á–µ–º
  if (modeRow)   modeRow.style.display   = hasMatch ? 'none' : '';
  if (turnRow)   turnRow.style.display   = hasMatch ? 'none' : '';
  if (ratingRow) ratingRow.style.display = hasMatch ? 'none' : '';
}
  
function getSkinById(id){ return SKINS.find(s=>s.id===id) || SKINS[0]; }

/* –ë–∞–Ω–Ω–µ—Ä —á–µ–π —Ö–æ–¥ */
function updateTurnBanner(){
  if(!turnBanner) return;
  turnBanner.classList.remove('my-turn','enemy-turn');

  if(!currentMatchId){
    turnBanner.textContent = '–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –º–∞—Ç—á–∞';
    return;
  }
  if(matchFinished){
    turnBanner.textContent = '–ú–∞—Ç—á –∑–∞–≤–µ—Ä—à—ë–Ω';
    return;
  }
  if(String(currentTurn)===String(PLAYER_ID)){
    turnBanner.textContent = '–¢–≤–æ–π —Ö–æ–¥ ‚Äî —Å—Ç—Ä–µ–ª—è–π –ø–æ –ø–æ–ª—é –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞';
    turnBanner.classList.add('my-turn');
  }else{
    turnBanner.textContent = '–•–æ–¥ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞ ‚Äî –∂–¥–∏';
    turnBanner.classList.add('enemy-turn');
  }
}

/* —Ç–æ—á–∫–∏ –≤–æ–∫—Ä—É–≥ —É—Ç–æ–ø–ª–µ–Ω–Ω–æ–≥–æ */
function markDotsAroundShip(gridEl, orderedCells) {
  if (!orderedCells || !orderedCells.length) return;
  const shipIdxSet = new Set(
    orderedCells.map(c =>
      (typeof c === 'number') ? c : cellIndex(c.x, c.y)
    )
  );
  const used = new Set();
  shipIdxSet.forEach(idx => {
    const { x, y } = coords(idx);
    for (let dy = -1; dy <= 1; dy++) {
      for (let dx = -1; dx <= 1; dx++) {
        const nx = x + dx;
        const ny = y + dy;
        if (nx < 0 || nx > 9 || ny < 0 || ny > 9) continue;
        const nIdx = cellIndex(nx, ny);
        if (shipIdxSet.has(nIdx)) continue;
        if (used.has(nIdx)) continue;
        used.add(nIdx);
        const cell = gridEl.children[nIdx];
        if (!cell) continue;
        if (
          cell.classList.contains('hit') ||
          cell.classList.contains('sunk') ||
          cell.classList.contains('miss')
        ) {
          continue;
        }
        cell.classList.add('dot');
      }
    }
  });
}

/* ====== –ø–æ–ª—è ====== */
function buildFields(){
  enemyField.innerHTML='';
  for(let i=0;i<100;i++){
    const c=document.createElement('div');
    c.className='cell';
    c.dataset.idx=i;
    c.addEventListener('click', onEnemyClick);
    c.addEventListener('touchend', e=>{e.preventDefault(); onEnemyClick.call(c,e);});
    enemyField.appendChild(c);
  }
  myField.innerHTML='';
  for(let i=0;i<100;i++){
    const c=document.createElement('div');
    c.className='cell';
    c.dataset.idx=i;
    c.addEventListener('click', onMyCellClick);
    c.addEventListener('touchend', e=>{e.preventDefault(); onMyCellClick.call(c,e);});
    myField.appendChild(c);
  }
}

/* ====== —Ä–∞—Å—Å—Ç–∞–Ω–æ–≤–∫–∞ + –æ—Ç—Ä–∏—Å–æ–≤–∫–∞ ====== */
function renderShipsPanel(){
  shipsPanel.innerHTML='';
  const unique=Array.from(new Set(SHIP_SIZES)).sort((a,b)=>b-a);
  unique.forEach(size=>{
    const left = shipsPool[size] || 0;
    const btn  = document.createElement('button');
    btn.className='ship-btn' + (selectedSize===size ? ' selected':'');
    btn.type='button';
    btn.innerText = `${size} √ó ${left}`;
    const handler = e=>{
      e.preventDefault();
      if(left<=0){ updateStatus('–ù–µ—Ç —Ç–∞–∫–∏—Ö –∫–æ—Ä–∞–±–ª–µ–π'); return; }
      selectedSize = (selectedSize===size)?null:size;
      renderShipsPanel();
      updateStatus();
    };
    btn.addEventListener('click',handler);
    btn.addEventListener('touchend',e=>{e.preventDefault();handler(e);});
    shipsPanel.appendChild(btn);
  });
}

function renderAll(){
  document.querySelectorAll('#myField .cell').forEach(c=>{
    c.className='cell';
    c.style.transform=''; c.innerHTML='';
  });
  const skin = getSkinById(equippedSkin);
  placed.forEach(ship=>{
    const parts=ship.cells;
    const size=ship.size;
    parts.forEach((cellIdx,i)=>{
      const el=myField.children[cellIdx];
      if(!el) return;
      let partName='body';
      if(size===1) partName='single';
      else if(i===0) partName='head';
      else if(i===parts.length-1) partName='tail';
      const url=skin.parts && skin.parts[partName];
      if(url){
        const img=document.createElement('img');
        img.className='part' + (ship.orientation==='V'?' rotated':'');
        img.draggable=false;
        img.src=url;
        el.appendChild(img);
      }else{
        el.style.background='var(--occupied)';
      }
      el.classList.add('occupied');
    });
  });
  renderShipsPanel();
  readyBtn.disabled = !allPlaced();
  updateStatus();
}
function allPlaced(){ return Object.values(shipsPool).every(v=>v===0); }

function placeShipAt(startIdx,size,orient){
  const cells=cellsFor(startIdx,size,orient);
  if(!cells) return {ok:false,reason:'out'};
  const bad=overlapsOrAdjacent(cells);
  if(bad){ if(bad.overlap) return {ok:false,reason:'overlap'}; if(bad.adjacent) return {ok:false,reason:'adjacent'}; }
  const ship={id:nextShipId++,size,start:startIdx,orientation:orient,cells};
  placed.push(ship);
  shipsPool[size]=(shipsPool[size]||0)-1;
  renderAll();
  return {ok:true,ship};
}
function findShipByCell(idx){ return placed.find(s=>s.cells.includes(idx)); }
function removeShipById(id){
  const i=placed.findIndex(s=>s.id===id);
  if(i===-1) return false;
  const s=placed[i];
  shipsPool[s.size]=(shipsPool[s.size]||0)+1;
  placed.splice(i,1);
  renderAll();
  return true;
}

function updateStatus(msg){
  if(msg){ statusEl.innerText=msg; logDbg(msg); return; }
  if(matchFinished){ statusEl.innerText='–ú–∞—Ç—á –∑–∞–≤–µ—Ä—à—ë–Ω'; return; }
  if(allPlaced()) statusEl.innerText='–í—Å–µ –∫–æ—Ä–∞–±–ª–∏ —Ä–∞—Å—Å—Ç–∞–≤–ª–µ–Ω—ã ‚Äî –Ω–∞–∂–º–∏ –ì–æ—Ç–æ–≤';
  else if(selectedSize) statusEl.innerText=`–í—ã–±—Ä–∞–Ω–æ ${selectedSize} (–æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è ${orientation})`;
  else statusEl.innerText='–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ—Ä–∞–±–ª—å';
}

/* –∫–ª–∏–∫ –ø–æ —Å–≤–æ–µ–º—É –ø–æ–ª—é */
function onMyCellClick(e){
  const el=e.currentTarget || this;
  const idx=parseInt(el.dataset.idx);
  if(eraseMode){
    const ship=findShipByCell(idx);
    if(ship){ removeShipById(ship.id); updateStatus('–ö–æ—Ä–∞–±–ª—å —É–¥–∞–ª—ë–Ω'); }
    else updateStatus('–ù–µ—Ç –∫–æ—Ä–∞–±–ª—è');
    return;
  }
  if(!selectedSize){ updateStatus('–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ—Ä–∞–±–ª—å'); return; }
  const res=placeShipAt(idx,selectedSize,orientation);
  if(!res.ok){
    if(res.reason==='out') updateStatus('–í—ã—Ö–æ–¥ –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã');
    else if(res.reason==='overlap') updateStatus('–ü–µ—Ä–µ–∫—Ä—ã—Ç–∏–µ');
    else if(res.reason==='adjacent') updateStatus('–†—è–¥–æ–º –¥—Ä—É–≥–æ–π –∫–æ—Ä–∞–±–ª—å');
    else updateStatus('–ù–µ–ª—å–∑—è –ø–æ—Å—Ç–∞–≤–∏—Ç—å');
  }else{
    updateStatus('–ö–æ—Ä–∞–±–ª—å –ø–æ—Å—Ç–∞–≤–ª–µ–Ω');
    if((shipsPool[selectedSize]||0)<=0) selectedSize=null;
  }
}

/* –∫–Ω–æ–ø–∫–∏ —Ä–∞—Å—Å—Ç–∞–Ω–æ–≤–∫–∏ */
rotateBtn.addEventListener('click',()=>{
  orientation=(orientation==='H')?'V':'H';
  rotateBtn.innerText=`–ü–æ–≤–µ—Ä–Ω—É—Ç—å (${orientation})`;
  updateStatus();
});
autoBtn.addEventListener('click',()=>{ randomPlaceAll(); updateStatus('–ê–≤—Ç–æ-—Ä–∞—Å—Å—Ç–∞–Ω–æ–≤–∫–∞'); });
undoBtn.addEventListener('click',()=>{
  if(placed.length===0){ updateStatus('–ù–µ—á–µ–≥–æ –æ—Ç–º–µ–Ω—è—Ç—å'); return; }
  const last=placed.pop();
  shipsPool[last.size]=(shipsPool[last.size]||0)+1;
  renderAll();
  updateStatus('–û—Ç–º–µ–Ω—ë–Ω –ø–æ—Å–ª–µ–¥–Ω–∏–π');
});
eraseModeBtn.addEventListener('click',()=>{
  eraseMode=!eraseMode;
  eraseModeBtn.innerText=`–£–¥–∞–ª–µ–Ω–∏–µ: ${eraseMode?'–≤–∫–ª':'–≤—ã–∫–ª'}`;
});

function clearAll(){
  placed=[]; shipsPool=group(SHIP_SIZES); nextShipId=1;
  selectedSize=null; orientation='H'; eraseMode=false;
  eraseModeBtn.innerText='–£–¥–∞–ª–µ–Ω–∏–µ: –≤—ã–∫–ª';
  renderAll();
}
function randomPlaceAll(){
  clearAll();
  const sizes=[...SHIP_SIZES].sort(()=>Math.random()-0.5);
  for(const s of sizes){
    let tries=0,ok=false;
    while(tries<500 && !ok){
      const start=Math.floor(Math.random()*100);
      const orient=Math.random()<0.5?'H':'V';
      const cells=cellsFor(start,s,orient);
      if(cells && !overlapsOrAdjacent(cells)){
        placed.push({id:nextShipId++,size:s,start,orientation:orient,cells});
        shipsPool[s]=(shipsPool[s]||0)-1;
        ok=true;
      }
      tries++;
    }
    if(!ok) return randomPlaceAll();
  }
  renderAll();
}

/* ====== —Å—Ç—Ä–µ–ª—å–±–∞ ====== */
function onEnemyClick(e){
  const el=e.currentTarget || this;
  const idx=parseInt(el.dataset.idx);

  if(matchFinished){ updateStatus('–ú–∞—Ç—á —É–∂–µ –∑–∞–≤–µ—Ä—à—ë–Ω'); return; }
  if(!currentMatchId){ updateStatus('–ù–µ—Ç –º–∞—Ç—á–∞ ‚Äî –Ω–∞–∂–º–∏ –ò–≥—Ä–∞—Ç—å –∏–ª–∏ –°–æ–∑–¥–∞—Ç—å'); return; }
  if(!currentTurn || String(currentTurn)!==String(PLAYER_ID)){ updateStatus('–°–µ–π—á–∞—Å –Ω–µ –≤–∞—à —Ö–æ–¥'); return; }
  if(el.classList.contains('miss')||el.classList.contains('hit')||el.classList.contains('sunk')||el.classList.contains('pending')){
    updateStatus('–í—ã —É–∂–µ —Å—Ç—Ä–µ–ª—è–ª–∏ —Å—é–¥–∞');
    return;
  }

  const {x,y}=coords(idx);
  if(!socket) initSocket();
  socket.emit('shoot',{matchId:currentMatchId,playerId:PLAYER_ID,x,y},(_,resp)=>{
    if(!resp || !resp.ok){
      if(resp && resp.error==='already_shot') updateStatus('–í—ã —É–∂–µ —Å—Ç—Ä–µ–ª—è–ª–∏ —Å—é–¥–∞');
      else if(resp && resp.error==='not_your_turn') updateStatus('–°–µ–π—á–∞—Å –Ω–µ –≤–∞—à —Ö–æ–¥');
      else updateStatus('–û—à–∏–±–∫–∞ –≤—ã—Å—Ç—Ä–µ–ª–∞');
      el.classList.remove('pending');
      return;
    }
  });
  el.classList.add('pending');
  updateStatus(`–í—ã—Å—Ç—Ä–µ–ª: ${x},${y} ‚Äî –∂–¥—ë–º –æ—Ç–≤–µ—Ç–∞`);
}

/* ====== –º–æ–¥–∞–ª–∫–∞ –∫–æ–Ω—Ü–∞ ====== */
function showEndModal(winnerId) {
  let baseText;
  if (winnerId && String(winnerId) === String(PLAYER_ID)) {
    baseText = '–¢—ã –≤—ã–∏–≥—Ä–∞–ª! üéâ';
  } else if (winnerId) {
    baseText = '–ü–æ–±–µ–¥–∏–ª —Å–æ–ø–µ—Ä–Ω–∏–∫.';
  } else {
    baseText = '–ú–∞—Ç—á –∑–∞–≤–µ—Ä—à—ë–Ω.';
  }

  const rank = getRankName(playerRating);
  const stats = `\n–†–µ–π—Ç–∏–Ω–≥: ${playerRating} (${rank})\n–ü–æ–±–µ–¥—ã: ${totalWins}  –ü–æ—Ä–∞–∂–µ–Ω–∏—è: ${totalLosses}`;
  endModalText.textContent = baseText + stats;
  endModal.style.display = 'flex';
}
function hideEndModal() { endModal.style.display = 'none'; }

endRematchBtn.addEventListener('click', () => {
  if (!socket) initSocket();
  if (!currentMatchId) {
    hideEndModal();
    return;
  }
  socket.emit('request_rematch', { matchId: currentMatchId, playerId: PLAYER_ID });
  updateStatus('–ó–∞–ø—Ä–æ—à–µ–Ω —Ä–µ–≤–∞–Ω—à, –∂–¥—ë–º —Å–æ–ø–µ—Ä–Ω–∏–∫–∞');
  hideEndModal();
});

endExitBtn.addEventListener('click', () => {
  if (!socket) initSocket();
  if (currentMatchId) {
    socket.emit('leave', { playerId: PLAYER_ID, matchId: currentMatchId });
  }
  currentMatchId = null;
  matchLabel.innerText = '‚Äî';
  matchFinished = false;
  updateTurnBanner();
  updateSidePanelState();
  hideEndModal();
  updateStatus('–í—ã –≤—ã—à–ª–∏ –≤ –º–µ–Ω—é');
  mainMenu.style.display = 'flex';
});

/* ====== Socket.IO ====== */
function initSocket(){
  if(socket) return;
  if(!SOCKET_URL || !SOCKET_URL.startsWith('http')){
    updateStatus('–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π SOCKET_URL');
    return;
  }
  socket = io(SOCKET_URL,{transports:['websocket']});

  socket.on('connect',()=>{
    logDbg('socket connected: '+socket.id);
    socket.emit('identify',{playerId:PLAYER_ID,username:PLAYER_NAME});
  });
  socket.on('connect_error',err=>{ logDbg('connect_error: '+(err && err.message?err.message:err)); });
  socket.on('disconnect',reason=>{ logDbg('disconnect: '+reason); });

  socket.on('identified',()=>{});

  socket.on('match_created',d=>{
    currentMatchId=d.matchId;
    matchLabel.innerText=currentMatchId;
    modeLabel.innerText='railway';
    updateStatus('–ú–∞—Ç—á —Å–æ–∑–¥–∞–Ω: '+currentMatchId);
    searchOverlay.style.display='none';
    updateTurnBanner();
    updateSidePanelState();  
  });

  socket.on('match_joined',d=>{
    currentMatchId=d.matchId;
    matchLabel.innerText=currentMatchId;
    modeLabel.innerText='railway';
    updateStatus('–ù–∞–π–¥–µ–Ω –º–∞—Ç—á: '+d.matchId);
    updateStatus('–í –º–∞—Ç—á–µ: '+currentMatchId);
    searchOverlay.style.display='none';
    updateTurnBanner();
    updateSidePanelState();
  });

  socket.on('match_found',d=>{
    currentMatchId=d.matchId;
    matchLabel.innerText=d.matchId;
    modeLabel.innerText='railway';
    currentTurn=d.turn;
    turnLabel.innerText=String(currentTurn||'‚Äî');
    applyEnemyRatingFromMatchPayload(d);
    updateStatus('–ù–∞–π–¥–µ–Ω –º–∞—Ç—á: '+d.matchId);
    searchOverlay.style.display='none';
    updateTurnBanner();
    updateSidePanelState();
  });

  socket.on('placement_update',()=>updateStatus('–ü—Ä–æ—Ç–∏–≤–Ω–∏–∫ –æ—Ç–ø—Ä–∞–≤–∏–ª —Ä–∞—Å—Å—Ç–∞–Ω–æ–≤–∫—É'));

  socket.on('match_started', d => {
    currentMatchId = d.matchId;
    currentTurn   = d.turn;
    matchLabel.innerText = currentMatchId;
    turnLabel.innerText  = String(currentTurn || '‚Äî');

    enemyField.querySelectorAll('.cell').forEach(c => {
      c.className = 'cell';
      c.innerHTML = '';
    });
    myField.querySelectorAll('.cell').forEach(c => {
      c.classList.remove('miss','hit','pending','sunk','sunk-preview','sunk-reveal','dot');
    });

    socket.on('rating_info', (d) => {
  if (!d) return;
  if (String(d.playerId) === String(PLAYER_ID) && typeof d.rating === 'number') {
    myRating = d.rating;
    recalcRanks();
    updateSidePanelState();
  }
});

socket.on('rating_update', (d) => {
  if (!d) return;
  if (String(d.playerId) === String(PLAYER_ID) && typeof d.rating === 'number') {
    myRating = d.rating;
    recalcRanks();
    updateSidePanelState();
  }
});

    updateStatus(
      String(currentTurn) === String(PLAYER_ID)
        ? '–ú–∞—Ç—á –Ω–∞—á–∞–ª—Å—è ‚Äî —Ç–≤–æ–π —Ö–æ–¥, —Å—Ç—Ä–µ–ª—è–π –ø–æ –ø–æ–ª—é –≤—Ä–∞–≥–∞'
        : '–ú–∞—Ç—á –Ω–∞—á–∞–ª—Å—è ‚Äî —Ö–æ–¥ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞, –∂–¥–∏'
    );
    updateTurnBanner();
    updateSidePanelState();
  });

socket.on('shot_result', d => {
  if (!d) return;
  const idx = cellIndex(d.x, d.y);

  // --- —Ä–∏—Å—É–µ–º –≤—ã—Å—Ç—Ä–µ–ª ---
  if (String(d.shooter) === String(PLAYER_ID)) {
    // –º—ã —Å—Ç—Ä–µ–ª—è–µ–º –ø–æ enemyField
    const cell = enemyField.children[idx];
    if (cell) {
      cell.classList.remove('pending');
      if (d.result === 'miss') {
        cell.classList.add('miss');
        cell.textContent = '‚Ä¢';
      } else if (d.result === 'hit') {
  cell.classList.remove('hit', 'miss', 'sunk');
  cell.innerHTML = '';
  cell.classList.add('explosion');

  const img = document.createElement('img');
  img.src = 'assets/effects/explosion.png';   // ‚Üê —Ç–≤–æ–π PNG –≤–∑—Ä—ã–≤–∞
  img.className = 'explosion-img';
  img.draggable = false;

  cell.appendChild(img);
      } else if (d.result === 'sunk') {
  cell.classList.remove('hit', 'miss');
  cell.innerHTML = '';
  cell.classList.add('explosion');

  const img = document.createElement('img');
  img.src = 'assets/effects/explosion.png';
  img.className = 'explosion-img';
  img.draggable = false;

  cell.appendChild(img);
      }
    }

    // –µ—Å–ª–∏ —É—Ç–æ–ø–∏–ª–∏ –∫–æ—Ä–∞–±–ª—å ‚Äî —Ç–æ—á–∫–∏ –≤–æ–∫—Ä—É–≥
    if (d.sunkShip && Array.isArray(d.sunkShip.cells)) {
      markDotsAroundShip(enemyField, d.sunkShip.cells);
    }

  } else {
    // –ø–æ –Ω–∞–º —Å—Ç—Ä–µ–ª—è—é—Ç (myField)
    const cell = myField.children[idx];
    if (cell) {
      if (d.result === 'miss') {
        cell.classList.add('miss');
        cell.textContent = '‚Ä¢';
      } else if (d.result === 'hit') {
        cell.classList.add('hit');
        cell.textContent = '√ó';
      } else if (d.result === 'sunk') {
        cell.classList.add('sunk');
        cell.textContent = '√ó';
      }
    }

    if (d.sunkShip && Array.isArray(d.sunkShip.cells)) {
      markDotsAroundShip(myField, d.sunkShip.cells);
    }
  }

  // --- –æ–±–Ω–æ–≤–ª—è–µ–º —Ö–æ–¥ –∏ –±–∞–Ω–Ω–µ—Ä ---
  currentTurn   = d.newTurn;
  matchFinished = !!d.finished;

  const myTurnNow = !matchFinished && String(currentTurn) === String(PLAYER_ID);
  turnLabel.innerText = matchFinished ? '‚Äî' : String(currentTurn || '‚Äî');

  updateTurnBanner();          // <- –°–Æ–î–ê –û–ß–ï–ù–¨ –í–ê–ñ–ù–û
  if (typeof updateSidePanelState === 'function') {
    updateSidePanelState();
  }

  const turnText = matchFinished
    ? ''
    : (myTurnNow ? ' –¢–≤–æ–π —Ö–æ–¥.' : ' –•–æ–¥ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞.');
  updateStatus(`–†–µ–∑—É–ª—å—Ç–∞—Ç: ${d.result} (${d.x},${d.y}).${turnText}`);

  if (matchFinished) {
    updateStatus('–ú–∞—Ç—á –∑–∞–≤–µ—Ä—à—ë–Ω. –ü–æ–±–µ–¥–∏—Ç–µ–ª—å: ' + (d.winner || '‚Äî'));
    showEndModal(d.winner);
    updateTurnBanner();
  }
});

  socket.on('match_finished', d => {
  matchFinished = true;

  // –æ–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π —Ä–µ–π—Ç–∏–Ω–≥
  if (d && d.winner) {
    gamesPlayed++;

    if (String(d.winner) === String(PLAYER_ID)) {
      // –ø–æ–±–µ–¥–∞
      myRating += 20;
      updateStatus('–ú–∞—Ç—á –∑–∞–≤–µ—Ä—à—ë–Ω. –¢—ã –≤—ã–∏–≥—Ä–∞–ª! +20 MMR');
    } else {
      // –ø–æ—Ä–∞–∂–µ–Ω–∏–µ
      myRating = Math.max(0, myRating - 15);
      updateStatus('–ú–∞—Ç—á –∑–∞–≤–µ—Ä—à—ë–Ω. –¢—ã –ø—Ä–æ–∏–≥—Ä–∞–ª. -15 MMR');
    }

    saveRating();
    updateRanksUI();
  } else {
    updateStatus('–ú–∞—Ç—á –∑–∞–≤–µ—Ä—à—ë–Ω.');
  }

  showEndModal(d && d.winner);
  updateTurnBanner();
});

  socket.on('rematch_started', d => {
    if (!d) return;
    currentMatchId = d.matchId;
    currentTurn    = d.turn;
    matchLabel.innerText = currentMatchId;
    turnLabel.innerText  = String(currentTurn || '‚Äî');

    enemyField.querySelectorAll('.cell').forEach(c => {
      c.className = 'cell';
      c.innerHTML = '';
    });
    myField.querySelectorAll('.cell').forEach(c => {
      c.className = 'cell';
      c.innerHTML = '';
    });

    clearAll();
    hideEndModal();
    matchFinished = false;
    updateStatus('–†–µ–≤–∞–Ω—à! –†–∞—Å—Å—Ç–∞–≤—å –∫–æ—Ä–∞–±–ª–∏ –∏ –Ω–∞–∂–º–∏ –ì–æ—Ç–æ–≤');
    updateTurnBanner();
    updateSidePanelState();
  });

  socket.on('rematch_pending',()=>{
    updateStatus('–ñ–¥—ë–º —Ä–µ—à–µ–Ω–∏–µ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞ –ø–æ —Ä–µ–≤–∞–Ω—à—É...');
  });

  socket.on('rematch_vote',()=>{
    updateStatus('–ò–≥—Ä–æ–∫ –∑–∞–ø—Ä–æ—Å–∏–ª —Ä–µ–≤–∞–Ω—à');
  });

  socket.on('player_left',()=>{
    updateStatus('–ò–≥—Ä–æ–∫ –≤—ã—à–µ–ª –∏–∑ –º–∞—Ç—á–∞');
    matchFinished=true;
    currentMatchId=null;
    matchLabel.innerText='‚Äî';
    updateTurnBanner();
    updateSidePanelState();
  });

  socket.on('purchase_result',data=>{
    if(!data) return;
    if(data.ok){
      if(Array.isArray(data.ownedSkins)) ownedSkins=data.ownedSkins;
      else if(data.skinId && !ownedSkins.includes(data.skinId)) ownedSkins.push(data.skinId);
      localStorage.setItem('owned_skins',JSON.stringify(ownedSkins));
      equippedSkin=data.skinId || equippedSkin;
      localStorage.setItem('equipped_skin',equippedSkin);
      updateStatus('–ü–æ–∫—É–ø–∫–∞ —É—Å–ø–µ—à–Ω–∞! –°–∫–∏–Ω –Ω–∞–¥–µ—Ç.');
      renderShopModalContent();
      renderAll();
    }else{
      updateStatus('–û—à–∏–±–∫–∞ –ø–æ–∫—É–ø–∫–∏: ' + (data.error || 'unknown'));
    }
  });

  socket.on('error',e=>logDbg('server error: ' + JSON.stringify(e)));
}

/* ====== –º–∞—Ç—á –∫–Ω–æ–ø–∫–∏ ====== */
function startQuickMatchSearch(){
  initSocket();
  searchOverlay.style.display='flex';
  socket.emit('find_match',{playerId:PLAYER_ID});
  updateStatus('–í –ø–æ–∏—Å–∫–µ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞...');
}

quickPlayBtn.addEventListener('click', startQuickMatchSearch);

menuPlayQuick.addEventListener('click',()=>{
  mainMenu.style.display='none';
  startQuickMatchSearch();
});

menuPlayFriend.addEventListener('click',()=>{
  mainMenu.style.display='none';
  updateStatus('–°–æ–∑–¥–∞–π –º–∞—Ç—á –∏–ª–∏ –≤–≤–µ–¥–∏ match id —Å–ø—Ä–∞–≤–∞');
});

menuShop.addEventListener('click',()=>{
  openShopModal();
});

createMatchBtn.addEventListener('click',()=>{
  initSocket();
  socket.emit('create_match',{playerId:PLAYER_ID});
  updateStatus('–°–æ–∑–¥–∞–Ω–∏–µ –º–∞—Ç—á–∞...');
});

joinMatchBtn.addEventListener('click',()=>{
  const id=matchIdInput.value.trim();
  if(!id){ updateStatus('–í–≤–µ–¥–∏—Ç–µ match id'); return; }
  initSocket();
  socket.emit('join_match',{matchId:id,playerId:PLAYER_ID});
  updateStatus('–ó–∞–ø—Ä–æ—à–µ–Ω–æ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ...');
});

leaveBtn.addEventListener('click',()=>{
  if(!socket) initSocket();
  if(currentMatchId){
    socket.emit('leave',{playerId:PLAYER_ID,matchId:currentMatchId});
  }
  currentMatchId=null;
  matchLabel.innerText='‚Äî';
  matchFinished=false;
  updateTurnBanner();
  updateSidePanelState();
  updateStatus('–í—ã –≤—ã—à–ª–∏ –∏–∑ –º–∞—Ç—á–∞');
});

readyBtn.addEventListener('click', () => {
  if (!allPlaced()) {
    updateStatus('–°–Ω–∞—á–∞–ª–∞ —Ä–∞–∑–º–µ—Å—Ç–∏ –≤—Å–µ –∫–æ—Ä–∞–±–ª–∏');
    return;
  }
  initSocket();
  socket.emit('place_ships', {
    matchId: currentMatchId,
    playerId: PLAYER_ID,
    ships: placed
  });
  updateStatus('–†–∞—Å—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞');
});

resignBtn.addEventListener('click', () => {
  if (!socket) initSocket();
  if (currentMatchId) {
    socket.emit('leave', { playerId: PLAYER_ID, matchId: currentMatchId });
  }
  currentMatchId = null;
  matchLabel.innerText = '‚Äî';
  matchFinished = false;
  updateTurnBanner();
  updateSidePanelState();
  updateStatus('–í—ã –≤—ã—à–ª–∏ –∏–∑ –º–∞—Ç—á–∞');
  mainMenu.style.display='flex';
});

/* ====== –ú–∞–≥–∞–∑–∏–Ω ====== */
shopBtn.addEventListener('click',openShopModal);
shopClose.addEventListener('click',closeShopModal);
shopModalBuyAll.addEventListener('click',()=>{
  if(WebApp && WebApp.openLink){
    try{ WebApp.openLink(SHOP_URL); return; }catch(e){}
  }
  window.open(SHOP_URL,'_blank');
});

function openShopModal(){
  renderShopModalContent();
  shopModal.style.display='flex';
}
function closeShopModal(){
  shopModal.style.display='none';
}

function renderShopModalContent(){
  shopModalContent.innerHTML='';
  SKINS.forEach(skin=>{
    const row=document.createElement('div');
    row.style.display='flex';
    row.style.alignItems='center';
    row.style.gap='8px';
    row.style.padding='8px';
    row.style.borderRadius='8px';

    const img=document.createElement('img');
    img.src=skin.parts.head;
    img.style.width='72px';
    img.style.height='44px';
    img.style.objectFit='cover';
    img.style.borderRadius='6px';
    row.appendChild(img);

    const info=document.createElement('div');
    info.style.flex='1';
    info.innerHTML = `<div style="font-weight:700">${skin.name}</div><div class="small">–¶–µ–Ω–∞: ${skin.price} stars</div>`;
    row.appendChild(info);

    const btn=document.createElement('button');
    btn.className='ship-btn';
    const owned=ownedSkins.includes(skin.id);
    btn.innerText = owned ? (equippedSkin===skin.id ? '–ù–∞–¥–µ—Ç–æ' : '–ù–∞–¥–µ—Ç—å') : '–ö—É–ø–∏—Ç—å';
    btn.onclick = ()=>{
      if(owned){
        equipSkinLocal(skin.id);
        renderShopModalContent();
      }else{
        buySkinRequest(skin.id);
      }
    };
    row.appendChild(btn);

    shopModalContent.appendChild(row);
  });
}

function equipSkinLocal(skinId){
  if(!ownedSkins.includes(skinId)) return;
  equippedSkin=skinId;
  localStorage.setItem('equipped_skin',equippedSkin);
  if(socket && socket.connected) socket.emit('equip_skin',{playerId:PLAYER_ID,skinId});
  renderShopModalContent();
  renderAll();
}

function buySkinRequest(skinId){
  if(!socket) initSocket();
  if(socket && socket.connected){
    socket.emit('buy_skin',{playerId:PLAYER_ID,skinId});
    updateStatus('–ü–æ–∫—É–ø–∫–∞: –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä...');
    return;
  }
  updateStatus('–û—Ç–∫—Ä—ã–≤–∞—é –º–∞–≥–∞–∑–∏–Ω –≤ –±–æ—Ç–µ');
  if(WebApp && WebApp.openLink) WebApp.openLink(SHOP_URL);
  else window.open(SHOP_URL,'_blank');
}

/* ====== Init ====== */
function initUI(){
  buildFields();
  renderShipsPanel();
  renderAll();
  modeLabel.innerText='railway';
  updateRanksUI();
  updateStatus('–ì–æ—Ç–æ–≤–æ ‚Äî –≤—ã–±–µ—Ä–∏ —Ä–µ–∂–∏–º –≤ –≥–ª–∞–≤–Ω–æ–º –º–µ–Ω—é');
  dbg.style.display='none';
  updateTurnBanner();
  updateSidePanelState();
}
initUI();

/* –∑–∞–≥—Ä—É–∑–∫–∞ –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Å–∫–∏–Ω–æ–≤ */
(function loadLocalShop(){
  const lsOwned=localStorage.getItem('owned_skins');
  if(lsOwned) try{ownedSkins=JSON.parse(lsOwned);}catch(e){}
  const eq=localStorage.getItem('equipped_skin');
  if(eq) equippedSkin=eq;
})();
</script>
</body>
  </html>
